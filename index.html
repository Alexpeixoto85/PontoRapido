<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ponto Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* ESTILOS EXISTENTES (MANTIDOS) – NENHUMA ALTERAÇÃO */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            padding: 25px;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        h1 i {
            color: #ff9800;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-left: 50px;
        }
        
        .tabs {
            display: flex;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .tab-button {
            padding: 16px 30px;
            background-color: #fff;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
            color: #555;
        }
        
        .tab-button:hover {
            background-color: #f8f9fa;
        }
        
        .tab-button.active {
            background-color: #283593;
            color: white;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background-color: #fff;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #1a237e;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-title i {
            color: #283593;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #283593;
            outline: none;
            box-shadow: 0 0 0 3px rgba(40, 53, 147, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #283593;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1a237e;
        }
        
        .btn-success {
            background-color: #2e7d32;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1b5e20;
        }
        
        .btn-secondary {
            background-color: #546e7a;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #455a64;
        }
        
        .btn-warning {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #f57c00;
        }
        
        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c62828;
        }
        
        .btn-info {
            background-color: #0288d1;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #0277bd;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .month-selector select {
            width: auto;
            min-width: 200px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        
        th {
            background-color: #283593;
            color: white;
            text-align: left;
            padding: 16px 12px;
            font-weight: 600;
            white-space: nowrap;
            border: 1px solid #ddd;
        }
        
        td {
            padding: 14px 12px;
            border: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        .time-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .day-type-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .day-type-text, .atestado-hours {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .atestado-hours {
            width: 100%;
            padding: 4px;
            border: 1px solid #ff9800;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .weekend {
            background-color: #f0f4ff;
        }
        
        .weekend .time-input, .weekend .day-type-select, .weekend .day-type-text, .weekend .atestado-hours {
            background-color: #f8faff;
        }
        
        .today {
            background-color: #e8f5e9;
        }
        
        .today .time-input, .today .day-type-select, .today .day-type-text, .today .atestado-hours {
            background-color: #f1f8e9;
        }
        
        .day-type-folga {
            background-color: #e8f5e9 !important;
        }
        
        .day-type-feriado {
            background-color: #fff3e0 !important;
        }
        
        .day-type-atestado {
            background-color: #e3f2fd !important;
        }
        
        .day-type-falta {
            background-color: #ffebee !important;
        }
        
        .negative-balance {
            color: #d32f2f;
            font-weight: bold;
        }
        
        .positive-balance {
            color: #2e7d32;
            font-weight: bold;
        }
        
        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .employee-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 5px solid #283593;
            transition: transform 0.2s;
        }
        
        .employee-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .employee-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #1a237e;
        }
        
        .employee-details {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .employee-actions {
            display: flex;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #546e7a;
        }
        
        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #b0bec5;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #546e7a;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #2e7d32;
            color: white;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.5s;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background-color: #d32f2f;
        }
        
        .notification.warning {
            background-color: #ff9800;
        }
        
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .import-export-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .total-hours {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        
        .total-hours span {
            color: #2e7d32;
            font-size: 18px;
        }
        
        .total-hours.negative {
            background-color: #ffebee;
        }
        
        .total-hours.negative span {
            color: #d32f2f;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-top: 4px solid #283593;
        }
        
        .summary-card.folga {
            border-top-color: #4caf50;
        }
        
        .summary-card.feriado {
            border-top-color: #ff9800;
        }
        
        .summary-card.atestado {
            border-top-color: #2196f3;
        }
        
        .summary-card.falta {
            border-top-color: #f44336;
        }
        
        .summary-card .number {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .summary-card .label {
            font-size: 14px;
            color: #666;
        }
        
        .holiday-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .workload-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .workload-field {
            flex: 1;
        }
        
        .workload-field label {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .workload-field input {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .daily-workload-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .daily-workload-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
        }
        
        .daily-workload-day {
            width: 120px;
            font-weight: 600;
        }
        
        .daily-workload-fields {
            display: flex;
            gap: 10px;
            flex: 1;
        }
        
        .daily-workload-fields input {
            padding: 8px;
            font-size: 14px;
        }
        
        .daily-workload-checkbox {
            margin-left: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 24px;
            color: #1a237e;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .month-selector {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .month-selector select {
                width: 100%;
            }
            
            .employee-list {
                grid-template-columns: 1fr;
            }
            
            .actions-bar {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .import-export-actions {
                flex-direction: column;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 14px;
            }
            
            .holiday-management {
                grid-template-columns: 1fr;
            }
            
            .workload-container {
                flex-direction: column;
            }
            
            .daily-workload-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .daily-workload-day {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .daily-workload-fields {
                width: 100%;
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-fingerprint"></i> Sistema de Registro de Ponto</h1>
            <p class="subtitle">Controle mensal com cálculo de horas extras, folgas, feriados e atestados parciais</p>
        </header>
        
        <div class="tabs">
            <button class="tab-button active" data-tab="registro">Registro de Ponto</button>
            <button class="tab-button" data-tab="funcionarios">Funcionários</button>
            <button class="tab-button" data-tab="feriados">Feriados</button>
            <button class="tab-button" data-tab="importar">Importar/Exportar</button>
            <button class="tab-button" data-tab="configuracoes">Configurações</button>
        </div>
        
        <!-- TAB 1: Registro de Ponto -->
        <div id="registro" class="tab-content active">
            <div class="card">
                <div class="actions-bar">
                    <div>
                        <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Registro de Ponto Mensal</h2>
                        <p>Preencha os horários de ponto - Atestados podem ser parciais (informe as horas cobertas)</p>
                    </div>
                    
                    <div class="form-group" style="width: 250px;">
                        <label for="employeeSelect">Funcionário:</label>
                        <select id="employeeSelect" class="employee-select">
                            <option value="">Selecione um funcionário</option>
                        </select>
                    </div>
                </div>
                
                <div class="month-selector">
                    <div>
                        <label for="monthSelect">Selecione o mês e ano:</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <select id="monthSelect">
                                <option value="0">Janeiro</option>
                                <option value="1">Fevereiro</option>
                                <option value="2">Março</option>
                                <option value="3">Abril</option>
                                <option value="4">Maio</option>
                                <option value="5">Junho</option>
                                <option value="6">Julho</option>
                                <option value="7">Agosto</option>
                                <option value="8">Setembro</option>
                                <option value="9">Outubro</option>
                                <option value="10">Novembro</option>
                                <option value="11">Dezembro</option>
                            </select>
                            <select id="yearSelect"></select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="exportCurrentPDF" class="btn btn-primary">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                        <button id="autoFill" class="btn btn-secondary">
                            <i class="fas fa-magic"></i> Preencher Automático
                        </button>
                        <button id="autoUpdate" class="btn btn-warning">
                            <i class="fas fa-sync-alt"></i> Atualizar Saldos
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="timesheetTable">
                        <thead>
                            <tr>
                                <th width="60">Dia</th>
                                <th width="120">Dia da Semana</th>
                                <th width="220">Tipo de Dia / Atestado (h)</th>
                                <th width="150">Entrada</th>
                                <th width="180">Saída (Intervalo)</th>
                                <th width="180">Volta (Intervalo)</th>
                                <th width="150">Saída</th>
                                <th width="120">Total Diário</th>
                                <th width="120">Saldo Diário</th>
                                <th width="100">Status</th>
                            </tr>
                        </thead>
                        <tbody id="timesheetBody">
                            <tr>
                                <td colspan="10" class="empty-state">
                                    <i class="fas fa-calendar-day"></i>
                                    <p>Selecione um funcionário, mês e ano para começar</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="total-hours">
                    <div>Total de horas normais no mês:</div>
                    <div><span id="totalMonthHours">00:00</span> horas</div>
                </div>
                
                <div class="total-hours" id="monthBalanceContainer" style="background-color: #fff3e0;">
                    <div>Saldo de horas no mês:</div>
                    <div><span id="totalMonthBalance">00:00</span> horas</div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card folga">
                        <div class="label">Dias de Folga</div>
                        <div class="number" id="totalFolgas">0</div>
                    </div>
                    <div class="summary-card feriado">
                        <div class="label">Feriados</div>
                        <div class="number" id="totalFeriados">0</div>
                    </div>
                    <div class="summary-card atestado">
                        <div class="label">Atestados</div>
                        <div class="number" id="totalAtestados">0</div>
                    </div>
                    <div class="summary-card falta">
                        <div class="label">Faltas</div>
                        <div class="number" id="totalFaltas">0</div>
                    </div>
                </div>
                
                <div style="margin-top: 25px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; gap: 10px;">
                        <button id="clearMonth" class="btn btn-secondary">
                            <i class="fas fa-eraser"></i> Limpar Mês
                        </button>
                        <button id="saveMonth" class="btn btn-success">
                            <i class="fas fa-save"></i> Salvar Registros
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="exportCurrent" class="btn btn-primary">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 2: Funcionários -->
        <div id="funcionarios" class="tab-content">
            <div class="card">
                <div class="actions-bar">
                    <h2 class="card-title"><i class="fas fa-users"></i> Funcionários Cadastrados</h2>
                    <button id="openEmployeeModal" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Novo Funcionário
                    </button>
                </div>
                
                <div id="employeesList" class="employee-list">
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <p>Nenhum funcionário cadastrado ainda. Use o formulário acima para adicionar.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: Feriados -->
        <div id="feriados" class="tab-content">
            <div class="card">
                <div class="actions-bar">
                    <h2 class="card-title"><i class="fas fa-calendar-day"></i> Feriados e Folgas Cadastrados</h2>
                    <button id="openHolidayModal" class="btn btn-primary">
                        <i class="fas fa-calendar-plus"></i> Novo Feriado/Folga
                    </button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="filterYear">Filtrar por ano:</label>
                    <select id="filterYear" style="width: 150px; margin-left: 10px;">
                        <option value="all">Todos os anos</option>
                    </select>
                </div>
                
                <div id="holidaysList" style="max-height: 400px; overflow-y: auto;">
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-calendar-times"></i>
                        <p>Nenhum feriado cadastrado ainda.</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h3 class="card-title" style="font-size: 18px;"><i class="fas fa-calendar-check"></i> Aplicar Folgas em Massa</h3>
                    <p>Selecione um período para aplicar folgas a todos os funcionários (útil para recessos coletivos)</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="massStartDate">Data Inicial *</label>
                            <input type="date" id="massStartDate">
                        </div>
                        <div class="form-group">
                            <label for="massEndDate">Data Final *</label>
                            <input type="date" id="massEndDate">
                        </div>
                        <div class="form-group">
                            <label for="massType">Tipo *</label>
                            <select id="massType">
                                <option value="folga">Folga</option>
                                <option value="feriado">Feriado</option>
                                <option value="recesso">Recesso</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="massReason">Motivo *</label>
                        <input type="text" id="massReason" placeholder="Ex: Recesso de fim de ano">
                    </div>
                    
                    <button id="applyMassLeave" class="btn btn-warning">
                        <i class="fas fa-calendar-alt"></i> Aplicar Folgas em Massa
                    </button>
                </div>
            </div>
        </div>
        
        <!-- TAB 4: Importar/Exportar -->
        <div id="importar" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-import"></i> Importar Dados</h2>
                <p>Importe dados de um arquivo Excel no formato correto</p>
                
                <div class="form-group">
                    <label for="importEmployee">Funcionário para importação:</label>
                    <select id="importEmployee">
                        <option value="">Selecione um funcionário</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="importFile">Arquivo Excel (.xlsx):</label>
                    <input type="file" id="importFile" accept=".xlsx, .xls">
                    <p style="margin-top: 10px; font-size: 14px; color: #666;">
                        <i class="fas fa-info-circle"></i> O arquivo deve ter o formato: Coluna A = Dia, B = Entrada, C = Saída (Intervalo), D = Volta (Intervalo), E = Saída
                    </p>
                </div>
                
                <button id="importExcel" class="btn btn-success">
                    <i class="fas fa-file-import"></i> Importar do Excel
                </button>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h3 class="card-title" style="font-size: 18px;"><i class="fas fa-database"></i> Backup dos Dados</h3>
                    <p>Faça backup de todos os dados do sistema (funcionários, registros de ponto e feriados)</p>
                    
                    <div class="import-export-actions">
                        <button id="exportBackup" class="btn btn-primary">
                            <i class="fas fa-download"></i> Fazer Backup
                        </button>
                        <button id="importBackup" class="btn btn-secondary">
                            <i class="fas fa-upload"></i> Restaurar Backup (Merge)
                        </button>
                        <button id="clearAllData" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i> Limpar Todos os Dados
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-export"></i> Exportar Dados</h2>
                <p>Exporte os registros de ponto para Excel ou PDF no formato padrão</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="exportEmployee">Funcionário:</label>
                        <select id="exportEmployee">
                            <option value="all">Todos os funcionários</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exportMonth">Mês:</label>
                        <select id="exportMonth">
                            <option value="all">Todos os meses</option>
                            <option value="0">Janeiro</option>
                            <option value="1">Fevereiro</option>
                            <option value="2">Março</option>
                            <option value="3">Abril</option>
                            <option value="4">Maio</option>
                            <option value="5">Junho</option>
                            <option value="6">Julho</option>
                            <option value="7">Agosto</option>
                            <option value="8">Setembro</option>
                            <option value="9">Outubro</option>
                            <option value="10">Novembro</option>
                            <option value="11">Dezembro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exportYear">Ano:</label>
                        <select id="exportYear">
                            <option value="all">Todos os anos</option>
                        </select>
                    </div>
                </div>
                
                <div class="import-export-actions">
                    <button id="exportExcel" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>
                    <button id="exportConsolidatedReport" class="btn btn-info">
                        <i class="fas fa-file-alt"></i> Relatório Consolidado (PDF)
                    </button>
                    <button id="exportAllMonthsPDF" class="btn btn-danger">
                        <i class="fas fa-file-pdf"></i> Todos os Meses (PDF)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- TAB 5: Configurações (nova) -->
        <div id="configuracoes" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-city"></i> Configuração de Cidade e Feriados</h2>
                <p>Selecione a cidade para carregar automaticamente os feriados nacionais e municipais correspondentes.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="citySelect">Cidade:</label>
                        <select id="citySelect">
                            <option value="">Selecione uma cidade</option>
                            <option value="SaoPaulo">São Paulo - SP</option>
                            <option value="RioDeJaneiro">Rio de Janeiro - RJ</option>
                            <option value="BeloHorizonte">Belo Horizonte - MG</option>
                            <option value="Brasilia">Brasília - DF</option>
                            <option value="Salvador">Salvador - BA</option>
                            <option value="Curitiba">Curitiba - PR</option>
                            <option value="PortoAlegre">Porto Alegre - RS</option>
                            <option value="Recife">Recife - PE</option>
                            <option value="Fortaleza">Fortaleza - CE</option>
                            <option value="Manaus">Manaus - AM</option>
                        </select>
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button id="loadCityHolidays" class="btn btn-primary">
                            <i class="fas fa-cloud-download-alt"></i> Carregar Feriados da Cidade
                        </button>
                    </div>
                </div>
                <p class="text-muted"><i class="fas fa-info-circle"></i> Os feriados serão mesclados com os já existentes, sem duplicação.</p>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i class="fas fa-sliders-h"></i> Comportamento do Sistema</h2>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoSaveOnlyLastExit" checked disabled> 
                        Salvamento automático apenas no preenchimento da última saída (ativado)
                    </label>
                    <p style="font-size: 14px; color: #666;">O sistema já está configurado para salvar automaticamente somente quando o campo "Saída" de qualquer dia é preenchido.</p>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Sistema de Registro de Ponto Completo - Armazenamento IndexedDB | Dados salvos localmente</p>
            <p>© 2025 - Com controle de feriados por cidade e jornada automática</p>
        </div>
        
        <div id="notification" class="notification">
            <i class="fas fa-check-circle"></i>
            <span id="notificationText">Operação realizada com sucesso!</span>
        </div>
    </div>

    <!-- Modal para Cadastro de Funcionários -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-plus"></i> Cadastro de Funcionário</h2>
                <span class="close">&times;</span>
            </div>
            
            <form id="employeeForm">
                <input type="hidden" id="employeeEditId" value="">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeName">Nome completo *</label>
                        <input type="text" id="employeeName" required>
                    </div>
                    <div class="form-group">
                        <label for="employeeId">Matrícula/ID *</label>
                        <input type="text" id="employeeId" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeDepartment">Departamento/Cargo</label>
                        <input type="text" id="employeeDepartment">
                    </div>
                    <div class="form-group">
                        <label for="employeeEmail">E-mail</label>
                        <input type="email" id="employeeEmail">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeAdmission">Data de Admissão</label>
                        <input type="date" id="employeeAdmission">
                    </div>
                    <div class="form-group">
                        <label for="employeeStatus">Status</label>
                        <select id="employeeStatus">
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                            <option value="ferias">Férias</option>
                            <option value="afastado">Afastado</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="workdayStart">Horário padrão de entrada</label>
                        <input type="time" id="workdayStart" value="08:00">
                    </div>
                    <div class="form-group">
                        <label for="workdayEnd">Horário padrão de saída</label>
                        <input type="time" id="workdayEnd" value="17:00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Jornada de Trabalho (para cálculo de horas extras)</label>
                    <div class="workload-container">
                        <div class="workload-field">
                            <label for="dailyWorkload">Horas por dia *</label>
                            <input type="number" id="dailyWorkload" min="1" max="12" step="0.5" value="8" required>
                        </div>
                        <div class="workload-field">
                            <label for="weeklyWorkload">Horas por semana *</label>
                            <input type="number" id="weeklyWorkload" min="1" max="60" step="0.5" value="44" required>
                        </div>
                        <div class="workload-field">
                            <label for="monthlyWorkload">Horas por mês *</label>
                            <input type="number" id="monthlyWorkload" min="1" max="300" step="0.5" value="220" required>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">* Saldo positivo (horas extras) e negativo (déficit) são calculados automaticamente</p>
                </div>
                
                <div class="daily-workload-container">
                    <label style="font-weight: bold; margin-bottom: 15px; display: block;">
                        <i class="fas fa-calendar-day"></i> Jornada Diária Individual (Personalizar por dia da semana)
                    </label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        Configure jornadas específicas para cada dia da semana. Deixe em branco para usar o horário padrão acima.
                    </p>
                    
                    <div id="dailyWorkloadConfig"></div>
                    
                    <div style="margin-top: 15px;">
                        <button type="button" id="copyMondayConfig" class="btn btn-sm btn-secondary">
                            <i class="fas fa-copy"></i> Copiar Segunda-feira para outros dias
                        </button>
                        <button type="button" id="resetDailyConfig" class="btn btn-sm btn-warning" style="margin-left: 10px;">
                            <i class="fas fa-undo"></i> Restaurar Padrão
                        </button>
                        <button type="button" id="applyWorkdayToDaily" class="btn btn-sm btn-info" style="margin-left: 10px;">
                            <i class="fas fa-clock"></i> Aplicar horário padrão aos dias de semana
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeFolgas">Dias de folga padrão (semana)</label>
                        <select id="employeeFolgas" multiple style="height: 120px;">
                            <option value="0">Domingo</option>
                            <option value="1">Segunda-feira</option>
                            <option value="2">Terça-feira</option>
                            <option value="3">Quarta-feira</option>
                            <option value="4">Quinta-feira</option>
                            <option value="5">Sexta-feira</option>
                            <option value="6">Sábado</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Segure Ctrl para selecionar múltiplos dias</p>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="closeEmployeeModal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="employeeSubmitBtn">
                        <i class="fas fa-user-plus"></i> Cadastrar Funcionário
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Cadastro de Feriados -->
    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-calendar-plus"></i> Adicionar Feriado/Folga</h2>
                <span class="close">&times;</span>
            </div>
            
            <form id="holidayForm">
                <div class="form-group">
                    <label for="holidayName">Nome do Feriado/Folga *</label>
                    <input type="text" id="holidayName" required placeholder="Ex: Natal, Ano Novo, Folga Compensatória">
                </div>
                
                <div class="form-group">
                    <label for="holidayType">Tipo *</label>
                    <select id="holidayType" required>
                        <option value="feriado">Feriado</option>
                        <option value="folga">Folga Compensatória</option>
                        <option value="recesso">Recesso</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="holidayDate">Data *</label>
                    <input type="date" id="holidayDate" required>
                </div>
                
                <div class="form-group">
                    <label for="holidayRecurring">Recorrente todo ano?</label>
                    <select id="holidayRecurring">
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="holidayDescription">Descrição (opcional)</label>
                    <textarea id="holidayDescription" rows="3" placeholder="Informações adicionais sobre o feriado"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="closeHolidayModal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i> Adicionar Feriado/Folga
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Configuração do IndexedDB ---
        const DB_NAME = 'PointRegisterDB';
        const DB_VERSION = 2;
        const STORES = {
            EMPLOYEES: 'employees',
            TIMESHEETS: 'timesheets',
            HOLIDAYS: 'holidays'
        };

        let db = null;
        let employees = [];
        let timesheets = {};
        let holidays = [];
        let currentEmployeeId = '';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let isEditingEmployee = false;
        let autoSaveTimeout = null;
        const AUTO_SAVE_DELAY = 2000;

        // --- Base de dados de feriados por cidade ---
        const holidayDatabase = {
            nacional: [
                { name: "Confraternização Universal", type: "feriado", month: 0, day: 1, recurring: true, description: "Ano Novo" },
                { name: "Tiradentes", type: "feriado", month: 3, day: 21, recurring: true, description: "Mártir da Inconfidência" },
                { name: "Dia do Trabalho", type: "feriado", month: 4, day: 1, recurring: true, description: "Dia Internacional do Trabalhador" },
                { name: "Independência do Brasil", type: "feriado", month: 8, day: 7, recurring: true, description: "7 de Setembro" },
                { name: "Nossa Senhora Aparecida", type: "feriado", month: 9, day: 12, recurring: true, description: "Padroeira do Brasil" },
                { name: "Finados", type: "feriado", month: 10, day: 2, recurring: true, description: "Dia de Finados" },
                { name: "Proclamação da República", type: "feriado", month: 10, day: 15, recurring: true, description: "15 de Novembro" },
                { name: "Natal", type: "feriado", month: 11, day: 25, recurring: true, description: "Natal" }
            ],
            moveis: [
                { name: "Carnaval", type: "feriado", date: "2025-03-04", recurring: false, description: "Terça-feira de Carnaval" },
                { name: "Sexta-feira Santa", type: "feriado", date: "2025-04-18", recurring: false, description: "Paixão de Cristo" },
                { name: "Corpus Christi", type: "feriado", date: "2025-06-19", recurring: false, description: "Corpus Christi" }
            ],
            cidades: {
                SaoPaulo: [
                    { name: "Aniversário de São Paulo", type: "feriado", month: 0, day: 25, recurring: true, description: "Fundação da cidade" },
                    { name: "Revolução Constitucionalista", type: "feriado", month: 6, day: 9, recurring: true, description: "Dia da Revolução de 1932" }
                ],
                RioDeJaneiro: [
                    { name: "Dia de São Jorge", type: "feriado", month: 3, day: 23, recurring: true, description: "Padroeiro do Rio" }
                ],
                BeloHorizonte: [
                    { name: "Aniversário de Belo Horizonte", type: "feriado", month: 11, day: 12, recurring: true, description: "Fundação da cidade" }
                ],
                Brasilia: [
                    { name: "Aniversário de Brasília", type: "feriado", month: 3, day: 21, recurring: true, description: "Fundação de Brasília" }
                ],
                Salvador: [
                    { name: "Dia de São João", type: "feriado", month: 5, day: 24, recurring: true, description: "Festa Junina" }
                ],
                Curitiba: [
                    { name: "Aniversário de Curitiba", type: "feriado", month: 2, day: 29, recurring: true, description: "Fundação da cidade" }
                ],
                PortoAlegre: [
                    { name: "Dia do Gaúcho", type: "feriado", month: 8, day: 20, recurring: true, description: "Revolução Farroupilha" }
                ],
                Recife: [
                    { name: "Aniversário do Recife", type: "feriado", month: 2, day: 12, recurring: true, description: "Fundação da cidade" }
                ],
                Fortaleza: [
                    { name: "Aniversário de Fortaleza", type: "feriado", month: 3, day: 13, recurring: true, description: "Fundação da cidade" }
                ],
                Manaus: [
                    { name: "Aniversário de Manaus", type: "feriado", month: 9, day: 24, recurring: true, description: "Fundação da cidade" }
                ]
            }
        };

        // --- Função auxiliar para converter string ISO (YYYY-MM-DD) em Date no fuso local ---
        function parseISOLocal(dateStr) {
            if (!dateStr) return null;
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d); // local time at midnight
        }

        // --- Função para gerar objetos de feriado (corrigida: usa currentYear) ---
        function generateHolidaysFromBase(cityKey) {
            const year = currentYear;
            let newHolidays = [];

            holidayDatabase.nacional.forEach(item => {
                const dateStr = `${year}-${String(item.month+1).padStart(2,'0')}-${String(item.day).padStart(2,'0')}`;
                newHolidays.push({
                    id: `nat-${item.month}-${item.day}-${Date.now()}-${Math.random()}`,
                    name: item.name,
                    type: item.type,
                    date: dateStr,
                    recurring: item.recurring,
                    description: item.description
                });
            });

            holidayDatabase.moveis.forEach(item => {
                newHolidays.push({
                    id: `mov-${item.date}-${Date.now()}-${Math.random()}`,
                    name: item.name,
                    type: item.type,
                    date: item.date,
                    recurring: false,
                    description: item.description
                });
            });

            if (cityKey && holidayDatabase.cidades[cityKey]) {
                holidayDatabase.cidades[cityKey].forEach(item => {
                    if (item.date) {
                        newHolidays.push({
                            id: `city-${cityKey}-${item.date}-${Date.now()}-${Math.random()}`,
                            name: item.name,
                            type: item.type,
                            date: item.date,
                            recurring: item.recurring || false,
                            description: item.description
                        });
                    } else if (item.month !== undefined) {
                        const dateStr = `${year}-${String(item.month+1).padStart(2,'0')}-${String(item.day).padStart(2,'0')}`;
                        newHolidays.push({
                            id: `city-${cityKey}-${item.month}-${item.day}-${Date.now()}-${Math.random()}`,
                            name: item.name,
                            type: item.type,
                            date: dateStr,
                            recurring: item.recurring,
                            description: item.description
                        });
                    }
                });
            }
            return newHolidays;
        }

        // --- Carregar feriados da cidade (mesclar) ---
        async function loadCityHolidays(cityKey) {
            if (!cityKey) {
                showNotification('Selecione uma cidade.', 'warning');
                return;
            }
            const newHolidays = generateHolidaysFromBase(cityKey);
            let added = 0;
            for (const h of newHolidays) {
                const exists = holidays.some(ex => ex.name === h.name && ex.date === h.date);
                if (!exists) {
                    await put(STORES.HOLIDAYS, h);
                    holidays.push(h);
                    added++;
                }
            }
            renderHolidaysList();
            showNotification(`${added} feriados carregados para a cidade selecionada.`);
            if (currentEmployeeId) generateCalendar();
        }

        // --- Aplicar horário padrão à jornada diária ---
        function applyWorkdayToDaily() {
            const workdayStart = document.getElementById('workdayStart').value;
            const workdayEnd = document.getElementById('workdayEnd').value;
            if (!workdayStart || !workdayEnd) return;

            const startMinutes = timeToMinutes(workdayStart);
            const endMinutes = timeToMinutes(workdayEnd);
            const totalMinutes = endMinutes - startMinutes;
            if (totalMinutes <= 0) return;

            let lunchStartMinutes = startMinutes + 4 * 60;
            let lunchEndMinutes = lunchStartMinutes + 60;
            if (lunchEndMinutes > endMinutes) {
                lunchStartMinutes = startMinutes + Math.floor(totalMinutes / 2);
                lunchEndMinutes = lunchStartMinutes + 60;
                if (lunchEndMinutes > endMinutes) {
                    lunchEndMinutes = endMinutes;
                    lunchStartMinutes = lunchEndMinutes - 60;
                }
            }
            const lunchStart = minutesToTime(lunchStartMinutes);
            const lunchEnd = minutesToTime(lunchEndMinutes);
            const hoursWorked = ((totalMinutes - 60) / 60).toFixed(2);

            for (let i = 1; i <= 5; i++) {
                document.getElementById(`dailyStart_${i}`).value = workdayStart;
                document.getElementById(`dailyLunchStart_${i}`).value = lunchStart;
                document.getElementById(`dailyLunchEnd_${i}`).value = lunchEnd;
                document.getElementById(`dailyEnd_${i}`).value = workdayEnd;
                document.getElementById(`dailyHours_${i}`).value = hoursWorked;
                document.getElementById(`dailyDayOff_${i}`).checked = false;
            }
            // Sábado
            document.getElementById(`dailyStart_6`).value = '09:00';
            document.getElementById(`dailyLunchStart_6`).value = '';
            document.getElementById(`dailyLunchEnd_6`).value = '';
            document.getElementById(`dailyEnd_6`).value = '13:00';
            document.getElementById(`dailyHours_6`).value = '4';
            document.getElementById(`dailyDayOff_6`).checked = false;
            // Domingo
            document.getElementById(`dailyStart_0`).value = '';
            document.getElementById(`dailyLunchStart_0`).value = '';
            document.getElementById(`dailyLunchEnd_0`).value = '';
            document.getElementById(`dailyEnd_0`).value = '';
            document.getElementById(`dailyHours_0`).value = '';
            document.getElementById(`dailyDayOff_0`).checked = true;

            showNotification('Jornada diária preenchida com os horários padrão.');
        }

        // --- IndexedDB helpers ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORES.EMPLOYEES)) {
                        db.createObjectStore(STORES.EMPLOYEES, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(STORES.TIMESHEETS)) {
                        db.createObjectStore(STORES.TIMESHEETS, { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains(STORES.HOLIDAYS)) {
                        const holidayStore = db.createObjectStore(STORES.HOLIDAYS, { keyPath: 'id' });
                        holidayStore.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        }

        async function getAll(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function put(storeName, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(value);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function deleteItem(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        async function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        async function getTimesheet(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORES.TIMESHEETS, 'readonly');
                const store = transaction.objectStore(STORES.TIMESHEETS);
                const request = store.get(key);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function saveTimesheet(key, daysData) {
            return put(STORES.TIMESHEETS, { key, ...daysData });
        }

        async function getAllTimesheets() {
            return getAll(STORES.TIMESHEETS);
        }

        // --- Inicialização ---
        async function initApp() {
            await openDB();
            employees = await getAll(STORES.EMPLOYEES) || [];
            const timesheetRecords = await getAllTimesheets() || [];
            timesheets = {};
            timesheetRecords.forEach(record => {
                const { key, ...daysData } = record;
                timesheets[key] = daysData;
            });
            holidays = await getAll(STORES.HOLIDAYS) || [];
            
            if (holidays.length === 0) {
                const defaultHolidays = generateHolidaysFromBase(null);
                for (const h of defaultHolidays) {
                    await put(STORES.HOLIDAYS, h);
                }
                holidays = defaultHolidays;
            }
            
            setupYearSelects();
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('yearSelect').value = currentYear;
            setupTabs();
            setupEventListeners();
            initDailyWorkloadConfig();
            setupModals();
            updateEmployeeSelects();
            renderEmployeesList();
            renderHolidaysList();
            
            showNotification('Sistema inicializado com IndexedDB!', 'info');
        }

        // --- Funções de UI ---
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        function setupYearSelects() {
            const yearSelect = document.getElementById('yearSelect');
            const exportYearSelect = document.getElementById('exportYear');
            const filterYearSelect = document.getElementById('filterYear');
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
                exportYearSelect.appendChild(option.cloneNode(true));
                filterYearSelect.appendChild(option.cloneNode(true));
            }
            yearSelect.value = currentYear;
            filterYearSelect.value = currentYear;
            document.getElementById('monthSelect').addEventListener('change', () => { if (currentEmployeeId) generateCalendar(); });
            document.getElementById('yearSelect').addEventListener('change', () => { if (currentEmployeeId) generateCalendar(); });
        }

        function setupModals() {
            const employeeModal = document.getElementById('employeeModal');
            document.getElementById('openEmployeeModal').addEventListener('click', () => {
                employeeModal.style.display = 'block';
                document.getElementById('employeeForm').reset();
                document.getElementById('employeeEditId').value = '';
                document.getElementById('employeeId').disabled = false;
                isEditingEmployee = false;
                document.getElementById('workdayStart').value = '08:00';
                document.getElementById('workdayEnd').value = '17:00';
                document.getElementById('dailyWorkload').value = '8';
                document.getElementById('weeklyWorkload').value = '44';
                document.getElementById('monthlyWorkload').value = '220';
                applyWorkdayToDaily();
            });

            document.getElementById('closeEmployeeModal').addEventListener('click', () => {
                employeeModal.style.display = 'none';
            });

            document.querySelectorAll('.close').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            document.getElementById('closeHolidayModal').addEventListener('click', () => {
                document.getElementById('holidayModal').style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
        }

        function initDailyWorkloadConfig() {
            const container = document.getElementById('dailyWorkloadConfig');
            const days = [
                { id: 0, name: 'Domingo' },
                { id: 1, name: 'Segunda-feira' },
                { id: 2, name: 'Terça-feira' },
                { id: 3, name: 'Quarta-feira' },
                { id: 4, name: 'Quinta-feira' },
                { id: 5, name: 'Sexta-feira' },
                { id: 6, name: 'Sábado' }
            ];
            container.innerHTML = '';
            days.forEach(day => {
                const row = document.createElement('div');
                row.className = 'daily-workload-row';
                row.innerHTML = `
                    <div class="daily-workload-day">${day.name}</div>
                    <div class="daily-workload-fields">
                        <input type="time" id="dailyStart_${day.id}" placeholder="Entrada" style="flex: 1;">
                        <input type="time" id="dailyLunchStart_${day.id}" placeholder="Saída Almoço" style="flex: 1;">
                        <input type="time" id="dailyLunchEnd_${day.id}" placeholder="Volta Almoço" style="flex: 1;">
                        <input type="time" id="dailyEnd_${day.id}" placeholder="Saída" style="flex: 1;">
                        <input type="number" id="dailyHours_${day.id}" placeholder="Horas" min="0" max="12" step="0.5" style="width: 80px;">
                    </div>
                    <div class="daily-workload-checkbox">
                        <input type="checkbox" id="dailyDayOff_${day.id}" class="day-off-checkbox">
                        <label for="dailyDayOff_${day.id}" style="font-size: 14px;">Folga</label>
                    </div>
                `;
                container.appendChild(row);
                const startInput = document.getElementById(`dailyStart_${day.id}`);
                const endInput = document.getElementById(`dailyEnd_${day.id}`);
                const hoursInput = document.getElementById(`dailyHours_${day.id}`);
                const calculateHours = () => {
                    if (startInput.value && endInput.value) {
                        const startTime = timeToMinutes(startInput.value);
                        const endTime = timeToMinutes(endInput.value);
                        const lunchStartTime = document.getElementById(`dailyLunchStart_${day.id}`).value ? 
                            timeToMinutes(document.getElementById(`dailyLunchStart_${day.id}`).value) : startTime + 4*60;
                        const lunchEndTime = document.getElementById(`dailyLunchEnd_${day.id}`).value ? 
                            timeToMinutes(document.getElementById(`dailyLunchEnd_${day.id}`).value) : lunchStartTime + 60;
                        let totalMinutes = endTime - startTime;
                        if (lunchStartTime && lunchEndTime) {
                            totalMinutes -= (lunchEndTime - lunchStartTime);
                        }
                        if (totalMinutes > 0) {
                            hoursInput.value = (totalMinutes / 60).toFixed(2);
                        }
                    }
                };
                startInput.addEventListener('change', calculateHours);
                endInput.addEventListener('change', calculateHours);
                const dayOffCheckbox = document.getElementById(`dailyDayOff_${day.id}`);
                dayOffCheckbox.addEventListener('change', function() {
                    const inputs = row.querySelectorAll('input:not(.day-off-checkbox)');
                    inputs.forEach(input => {
                        input.disabled = this.checked;
                        if (this.checked) input.value = '';
                    });
                });
            });

            document.getElementById('copyMondayConfig').addEventListener('click', function() {
                const mondayStart = document.getElementById('dailyStart_1').value;
                const mondayLunchStart = document.getElementById('dailyLunchStart_1').value;
                const mondayLunchEnd = document.getElementById('dailyLunchEnd_1').value;
                const mondayEnd = document.getElementById('dailyEnd_1').value;
                const mondayHours = document.getElementById('dailyHours_1').value;
                for (let i = 2; i <= 6; i++) {
                    document.getElementById(`dailyStart_${i}`).value = mondayStart;
                    document.getElementById(`dailyLunchStart_${i}`).value = mondayLunchStart;
                    document.getElementById(`dailyLunchEnd_${i}`).value = mondayLunchEnd;
                    document.getElementById(`dailyEnd_${i}`).value = mondayEnd;
                    document.getElementById(`dailyHours_${i}`).value = mondayHours;
                }
                showNotification('Configuração da segunda-feira copiada para terça a sábado!');
            });

            document.getElementById('resetDailyConfig').addEventListener('click', function() {
                const defaultConfig = [
                    { day: 0, start: '', lunchStart: '', lunchEnd: '', end: '', hours: '', dayOff: true },
                    { day: 1, start: '08:00', lunchStart: '12:00', lunchEnd: '13:00', end: '17:00', hours: '8', dayOff: false },
                    { day: 2, start: '08:00', lunchStart: '12:00', lunchEnd: '13:00', end: '17:00', hours: '8', dayOff: false },
                    { day: 3, start: '08:00', lunchStart: '12:00', lunchEnd: '13:00', end: '17:00', hours: '8', dayOff: false },
                    { day: 4, start: '08:00', lunchStart: '12:00', lunchEnd: '13:00', end: '17:00', hours: '8', dayOff: false },
                    { day: 5, start: '08:00', lunchStart: '12:00', lunchEnd: '13:00', end: '17:00', hours: '8', dayOff: false },
                    { day: 6, start: '09:00', lunchStart: '', lunchEnd: '', end: '13:00', hours: '4', dayOff: false }
                ];
                defaultConfig.forEach(config => {
                    document.getElementById(`dailyStart_${config.day}`).value = config.start;
                    document.getElementById(`dailyLunchStart_${config.day}`).value = config.lunchStart;
                    document.getElementById(`dailyLunchEnd_${config.day}`).value = config.lunchEnd;
                    document.getElementById(`dailyEnd_${config.day}`).value = config.end;
                    document.getElementById(`dailyHours_${config.day}`).value = config.hours;
                    const checkbox = document.getElementById(`dailyDayOff_${config.day}`);
                    checkbox.checked = config.dayOff;
                    const row = checkbox.closest('.daily-workload-row');
                    const inputs = row.querySelectorAll('input:not(.day-off-checkbox)');
                    inputs.forEach(input => { input.disabled = config.dayOff; });
                });
                showNotification('Configuração padrão restaurada!');
            });

            document.getElementById('applyWorkdayToDaily').addEventListener('click', applyWorkdayToDaily);
        }

        function setupEventListeners() {
            document.getElementById('exportCurrentPDF').addEventListener('click', exportCurrentTimesheetPDF);
            document.getElementById('autoFill').addEventListener('click', autoFillTimesheet);
            document.getElementById('autoUpdate').addEventListener('click', autoUpdateBalances);
            document.getElementById('saveMonth').addEventListener('click', saveTimesheet);
            document.getElementById('clearMonth').addEventListener('click', clearTimesheet);
            document.getElementById('exportCurrent').addEventListener('click', exportCurrentTimesheet);
            document.getElementById('employeeForm').addEventListener('submit', handleEmployeeForm);
            document.getElementById('holidayForm').addEventListener('submit', addHoliday);
            document.getElementById('applyMassLeave').addEventListener('click', applyMassLeave);
            document.getElementById('filterYear').addEventListener('change', renderHolidaysList);
            document.getElementById('importExcel').addEventListener('click', importFromExcel);
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('exportConsolidatedReport').addEventListener('click', exportConsolidatedReportPDF);
            document.getElementById('exportAllMonthsPDF').addEventListener('click', exportAllMonthsPDF);
            document.getElementById('exportBackup').addEventListener('click', exportBackup);
            document.getElementById('importBackup').addEventListener('click', importBackupMerge);
            document.getElementById('clearAllData').addEventListener('click', clearAllData);
            document.getElementById('employeeSelect').addEventListener('change', function() {
                currentEmployeeId = this.value;
                if (currentEmployeeId) generateCalendar();
            });
            document.getElementById('loadCityHolidays').addEventListener('click', () => {
                const city = document.getElementById('citySelect').value;
                loadCityHolidays(city);
            });
        }

        // --- Funções principais do calendário ---
        async function generateCalendar() {
            if (!currentEmployeeId) return;
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const today = new Date();
            const timesheetKey = `${currentEmployeeId}-${year}-${month}`;
            const savedTimesheet = await getTimesheet(timesheetKey);
            const savedData = savedTimesheet || {};
            const employee = employees.find(emp => emp.id === currentEmployeeId);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const timesheetBody = document.getElementById('timesheetBody');
            timesheetBody.innerHTML = '';

            let totalFolgas = 0, totalFeriados = 0, totalAtestados = 0, totalFaltas = 0;

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const dayName = getDayName(dayOfWeek);
                const dailyWorkload = employee ? getDailyWorkloadForDay(employee, dayOfWeek) : null;
                const holiday = checkIfHoliday(currentDate);
                let isDefaultDayOff = employee && employee.defaultDaysOff && employee.defaultDaysOff.includes(dayOfWeek);
                let defaultDayType = 'normal';
                let defaultDayTypeText = 'Dia Normal';
                if (dayOfWeek === 0) { defaultDayType = 'folga'; defaultDayTypeText = 'Folga (Domingo)'; }
                if (holiday) { defaultDayType = holiday.type; defaultDayTypeText = holiday.name; }
                else if (isDefaultDayOff) { defaultDayType = 'folga'; defaultDayTypeText = 'Folga Semanal'; }
                else if (dailyWorkload && dailyWorkload.dayOff) { defaultDayType = 'folga'; defaultDayTypeText = 'Folga (Jornada Personalizada)'; }

                let dayData = {
                    entrada: '', saidaIntervalo: '', voltaIntervalo: '', saida: '',
                    dayType: defaultDayType, dayTypeText: defaultDayTypeText, atestadoHours: '', observacao: ''
                };
                if (savedData && savedData[day]) dayData = { ...dayData, ...savedData[day] };

                if (dayData.dayType === 'folga') totalFolgas++;
                else if (dayData.dayType === 'feriado') totalFeriados++;
                else if (dayData.dayType === 'atestado') totalAtestados++;
                else if (dayData.dayType === 'falta') totalFaltas++;

                let totalDiario = '', saldoDiario = '', status = '', rowClass = '';
                if (dayData.dayType === 'normal' || dayData.dayType === 'atestado') {
                    const resultado = calculateDailyBalance(dayData, employee, dayOfWeek);
                    totalDiario = resultado.total;
                    saldoDiario = resultado.balance;
                    if (dayData.entrada && dayData.saida) status = '<span style="color: #2e7d32">Completo</span>';
                    else if (dayData.entrada || dayData.saidaIntervalo || dayData.voltaIntervalo || dayData.saida) {
                        status = '<span style="color: #ff9800">Parcial</span>';
                        rowClass = 'incomplete-day';
                    } else {
                        status = '<span style="color: #9e9e9e">Não preenchido</span>';
                        rowClass = 'empty-day';
                    }
                } else {
                    status = `<span style="color: #5d4037">${dayData.dayTypeText || dayData.dayType}</span>`;
                    rowClass = `day-type-${dayData.dayType}`;
                }
                if (isWeekend) rowClass += ' weekend';
                if (isToday) rowClass += ' today';

                const row = document.createElement('tr');
                if (rowClass) row.className = rowClass;

                const dayTypeOptions = `
                    <option value="normal" ${dayData.dayType === 'normal' ? 'selected' : ''}>Dia Normal</option>
                    <option value="folga" ${dayData.dayType === 'folga' ? 'selected' : ''}>Folga</option>
                    <option value="feriado" ${dayData.dayType === 'feriado' ? 'selected' : ''}>Feriado</option>
                    <option value="atestado" ${dayData.dayType === 'atestado' ? 'selected' : ''}>Atestado Médico</option>
                    <option value="ferias" ${dayData.dayType === 'ferias' ? 'selected' : ''}>Férias</option>
                    <option value="falta" ${dayData.dayType === 'falta' ? 'selected' : ''}>Falta</option>
                    <option value="compensacao" ${dayData.dayType === 'compensacao' ? 'selected' : ''}>Banco de Horas</option>
                `;
                const tipoCell = document.createElement('td');
                tipoCell.innerHTML = `
                    <select class="day-type-select" data-day="${day}" data-original="${dayData.dayType}">
                        ${dayTypeOptions}
                    </select>
                    <input type="text" class="day-type-text" data-day="${day}" value="${dayData.dayTypeText || ''}" placeholder="Motivo" style="margin-top: 5px; display: ${dayData.dayType !== 'normal' ? 'block' : 'none'}; width: 100%; padding: 4px; font-size: 12px;">
                    <input type="number" class="atestado-hours" data-day="${day}" value="${dayData.atestadoHours || ''}" placeholder="Horas atestado" min="0" max="24" step="0.5" style="margin-top: 5px; display: ${dayData.dayType === 'atestado' ? 'block' : 'none'}; width: 100%; padding: 4px; font-size: 12px;">
                `;
                row.innerHTML = `<td>${day}</td><td>${dayName}</td>`;
                row.appendChild(tipoCell);
                row.innerHTML += `
                    <td><input type="time" class="time-input entrada" data-day="${day}" value="${dayData.entrada}" ${dayData.dayType !== 'normal' && dayData.dayType !== 'atestado' ? 'disabled' : ''}></td>
                    <td><input type="time" class="time-input saida-intervalo" data-day="${day}" value="${dayData.saidaIntervalo}" ${dayData.dayType !== 'normal' && dayData.dayType !== 'atestado' ? 'disabled' : ''}></td>
                    <td><input type="time" class="time-input volta-intervalo" data-day="${day}" value="${dayData.voltaIntervalo}" ${dayData.dayType !== 'normal' && dayData.dayType !== 'atestado' ? 'disabled' : ''}></td>
                    <td><input type="time" class="time-input saida" data-day="${day}" value="${dayData.saida}" ${dayData.dayType !== 'normal' && dayData.dayType !== 'atestado' ? 'disabled' : ''}></td>
                    <td>${totalDiario}</td>
                    <td class="${saldoDiario.startsWith('-') ? 'negative-balance' : 'positive-balance'}">${saldoDiario}</td>
                    <td>${status}</td>
                `;
                timesheetBody.appendChild(row);
            }

            document.getElementById('totalFolgas').textContent = totalFolgas;
            document.getElementById('totalFeriados').textContent = totalFeriados;
            document.getElementById('totalAtestados').textContent = totalAtestados;
            document.getElementById('totalFaltas').textContent = totalFaltas;

            document.querySelectorAll('.day-type-select').forEach(select => {
                select.addEventListener('change', function() { handleDayTypeChange(this); });
            });
            document.querySelectorAll('.atestado-hours').forEach(input => {
                input.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const dayOfWeek = new Date(year, month, parseInt(row.querySelector('.entrada').getAttribute('data-day'))).getDay();
                    calculateDailyTotalForRow(row, dayOfWeek);
                    calculateMonthTotal();
                });
            });

            // Auto-save apenas no campo "saida"
            document.querySelectorAll('.time-input').forEach(input => {
                input.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const dayOfWeek = new Date(year, month, parseInt(row.querySelector('.entrada').getAttribute('data-day'))).getDay();
                    calculateDailyTotalForRow(row, dayOfWeek);
                    calculateMonthTotal();
                    if (this.classList.contains('saida')) {
                        triggerAutoSave();
                        const day = parseInt(row.querySelector('.entrada').getAttribute('data-day'));
                        if (day === daysInMonth) {
                            setTimeout(() => {
                                saveTimesheet();
                                showNotification('Último dia do mês preenchido. Registros salvos automaticamente!');
                            }, 1000);
                        }
                    }
                });
            });

            calculateMonthTotal();
        }

        // --- Função corrigida para verificar feriados (sem problemas de fuso) ---
        function checkIfHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth();      // 0-11
            const day = date.getDate();          // 1-31
            for (const holiday of holidays) {
                // Extrair componentes da string ISO do feriado
                const [hYear, hMonth, hDay] = holiday.date.split('-').map(Number);
                if (holiday.recurring) {
                    if (hMonth - 1 === month && hDay === day) {
                        return holiday;
                    }
                } else {
                    if (hYear === year && hMonth - 1 === month && hDay === day) {
                        return holiday;
                    }
                }
            }
            return null;
        }

        function timeToMinutes(time) {
            if (!time) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function formatMinutes(minutes) {
            const sign = minutes < 0 ? '-' : '+';
            const absMinutes = Math.abs(minutes);
            const hours = Math.floor(absMinutes / 60);
            const mins = absMinutes % 60;
            return `${sign}${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function formatMinutesToHM(minutes, includeSign = false) {
            if (includeSign) return formatMinutes(minutes);
            const absMinutes = Math.abs(minutes);
            const hours = Math.floor(absMinutes / 60);
            const mins = absMinutes % 60;
            return hours.toString().padStart(2, '0') + ':' + mins.toString().padStart(2, '0');
        }

        function getDayName(dayIndex) {
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            return days[dayIndex];
        }

        function getMonthName(monthIndex) {
            const months = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            return months[monthIndex];
        }

        function calculateDailyBalance(dayData, employee, dayOfWeek) {
            if (dayData.dayType !== 'normal' && dayData.dayType !== 'atestado') return { total: '', balance: '' };
            const entradaTime = timeToMinutes(dayData.entrada);
            const saidaTime = timeToMinutes(dayData.saida);
            let totalMinutes = saidaTime - entradaTime;
            if (dayData.saidaIntervalo && dayData.voltaIntervalo) {
                const saidaIntervaloTime = timeToMinutes(dayData.saidaIntervalo);
                const voltaIntervaloTime = timeToMinutes(dayData.voltaIntervalo);
                totalMinutes -= (voltaIntervaloTime - saidaIntervaloTime);
            }
            if (totalMinutes < 0) totalMinutes = 0;
            let expectedWorkloadMinutes;
            if (employee && employee.dailyWorkloads && employee.dailyWorkloads[dayOfWeek]) {
                expectedWorkloadMinutes = (employee.dailyWorkloads[dayOfWeek].hours || employee.dailyWorkload || 8) * 60;
            } else {
                expectedWorkloadMinutes = (employee ? employee.dailyWorkload : 8) * 60;
            }
            let requiredMinutes = expectedWorkloadMinutes;
            if (dayData.dayType === 'atestado' && dayData.atestadoHours) {
                const atestadoMinutes = parseFloat(dayData.atestadoHours) * 60;
                requiredMinutes = Math.max(0, expectedWorkloadMinutes - atestadoMinutes);
            }
            const balanceMinutes = totalMinutes - requiredMinutes;
            return { total: formatMinutesToHM(totalMinutes), balance: formatMinutes(balanceMinutes) };
        }

        function calculateDailyTotalForRow(row, dayOfWeek) {
            const entrada = row.querySelector('.entrada').value;
            const saidaIntervalo = row.querySelector('.saida-intervalo').value;
            const voltaIntervalo = row.querySelector('.volta-intervalo').value;
            const saida = row.querySelector('.saida').value;
            const dayType = row.querySelector('.day-type-select').value;
            const atestadoHours = parseFloat(row.querySelector('.atestado-hours')?.value) || 0;
            const employee = employees.find(emp => emp.id === currentEmployeeId);
            let totalDiario = '', saldoDiario = '';
            const statusCell = row.querySelector('td:last-child');
            if (dayType === 'normal' || dayType === 'atestado') {
                if (entrada && saida) {
                    statusCell.innerHTML = '<span style="color: #2e7d32">Completo</span>';
                    row.classList.remove('incomplete-day');
                    const dayData = { entrada, saidaIntervalo, voltaIntervalo, saida, dayType, atestadoHours };
                    const resultado = calculateDailyBalance(dayData, employee, dayOfWeek);
                    totalDiario = resultado.total;
                    saldoDiario = resultado.balance;
                } else if (entrada || saidaIntervalo || voltaIntervalo || saida) {
                    statusCell.innerHTML = '<span style="color: #ff9800">Parcial</span>';
                    row.classList.add('incomplete-day');
                    const dayData = { entrada, saidaIntervalo, voltaIntervalo, saida, dayType, atestadoHours };
                    const resultado = calculateDailyBalance(dayData, employee, dayOfWeek);
                    totalDiario = resultado.total;
                    saldoDiario = resultado.balance;
                } else {
                    statusCell.innerHTML = '<span style="color: #9e9e9e">Não preenchido</span>';
                    row.classList.remove('incomplete-day');
                    if (employee) {
                        const expectedWorkload = getDailyWorkloadForDay(employee, dayOfWeek);
                        const expectedMinutes = (expectedWorkload.hours || employee.dailyWorkload || 8) * 60;
                        const requiredMinutes = dayType === 'atestado' ? expectedMinutes - (atestadoHours * 60) : expectedMinutes;
                        totalDiario = '00:00';
                        saldoDiario = formatMinutes(-requiredMinutes);
                    }
                }
            }
            row.querySelector('td:nth-child(8)').textContent = totalDiario;
            const saldoCell = row.querySelector('td:nth-child(9)');
            saldoCell.textContent = saldoDiario;
            saldoCell.className = saldoDiario.startsWith('-') ? 'negative-balance' : 'positive-balance';
        }

        function calculateMonthTotal() {
            const rows = document.querySelectorAll('#timesheetBody tr');
            let totalMinutes = 0, totalBalanceMinutes = 0;
            rows.forEach(row => {
                const dayType = row.querySelector('.day-type-select').value;
                if (dayType === 'normal' || dayType === 'atestado') {
                    const totalCell = row.querySelector('td:nth-child(8)').textContent;
                    const balanceCell = row.querySelector('td:nth-child(9)').textContent;
                    if (totalCell && totalCell !== '') {
                        const [hours, minutes] = totalCell.split(':').map(Number);
                        totalMinutes += hours * 60 + minutes;
                    }
                    if (balanceCell && balanceCell !== '') {
                        const isNegative = balanceCell.startsWith('-');
                        const [hours, minutes] = balanceCell.replace(/[+-]/, '').split(':').map(Number);
                        totalBalanceMinutes += (isNegative ? -1 : 1) * (hours * 60 + minutes);
                    }
                }
            });
            document.getElementById('totalMonthHours').textContent = formatMinutesToHM(totalMinutes);
            document.getElementById('totalMonthBalance').textContent = formatMinutesToHM(totalBalanceMinutes, true);
            const balanceContainer = document.getElementById('monthBalanceContainer');
            if (totalBalanceMinutes < 0) {
                balanceContainer.className = 'total-hours negative';
            } else {
                balanceContainer.className = 'total-hours';
                balanceContainer.style.backgroundColor = '#fff3e0';
            }
        }

        function handleDayTypeChange(select) {
            const row = select.closest('tr');
            const newType = select.value;
            select.setAttribute('data-original', newType);
            const textInput = row.querySelector('.day-type-text');
            textInput.style.display = newType !== 'normal' ? 'block' : 'none';
            const atestadoInput = row.querySelector('.atestado-hours');
            atestadoInput.style.display = newType === 'atestado' ? 'block' : 'none';
            const timeInputs = row.querySelectorAll('.time-input');
            timeInputs.forEach(input => {
                input.disabled = !(newType === 'normal' || newType === 'atestado');
                if (!(newType === 'normal' || newType === 'atestado')) input.value = '';
            });
            row.className = '';
            if (newType !== 'normal') row.classList.add(`day-type-${newType}`);
            const statusCell = row.querySelector('td:last-child');
            statusCell.innerHTML = (newType === 'normal' || newType === 'atestado') ? '<span style="color: #9e9e9e">Não preenchido</span>' : `<span style="color: #5d4037">${newType}</span>`;
            row.querySelector('td:nth-child(8)').textContent = '';
            row.querySelector('td:nth-child(9)').textContent = '';
            calculateMonthTotal();
            updateSummaryCounts();
        }

        function updateSummaryCounts() {
            const rows = document.querySelectorAll('#timesheetBody tr');
            let totalFolgas = 0, totalFeriados = 0, totalAtestados = 0, totalFaltas = 0;
            rows.forEach(row => {
                const dayType = row.querySelector('.day-type-select').value;
                if (dayType === 'folga') totalFolgas++;
                else if (dayType === 'feriado') totalFeriados++;
                else if (dayType === 'atestado') totalAtestados++;
                else if (dayType === 'falta') totalFaltas++;
            });
            document.getElementById('totalFolgas').textContent = totalFolgas;
            document.getElementById('totalFeriados').textContent = totalFeriados;
            document.getElementById('totalAtestados').textContent = totalAtestados;
            document.getElementById('totalFaltas').textContent = totalFaltas;
        }

        function triggerAutoSave() {
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                if (currentEmployeeId) saveTimesheet();
            }, AUTO_SAVE_DELAY);
        }

        // --- Funções de salvamento e manipulação de dados (corrigidas) ---
        async function saveTimesheet() {
            if (!currentEmployeeId) {
                showNotification('Selecione um funcionário primeiro!', 'error');
                return;
            }
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const timesheetKey = `${currentEmployeeId}-${year}-${month}`;
            const daysData = {};
            const rows = document.querySelectorAll('#timesheetBody tr');
            
            // Verifica se há linhas e se não é a linha de estado vazio
            if (rows.length === 0 || rows[0].querySelector('.empty-state')) {
                showNotification('Nenhum dado para salvar!', 'warning');
                return;
            }
            
            rows.forEach(row => {
                const dayInput = row.querySelector('.entrada');
                if (!dayInput) return;
                const day = dayInput.getAttribute('data-day');
                if (!day) return;
                daysData[day] = {
                    entrada: dayInput.value,
                    saidaIntervalo: row.querySelector('.saida-intervalo').value,
                    voltaIntervalo: row.querySelector('.volta-intervalo').value,
                    saida: row.querySelector('.saida').value,
                    dayType: row.querySelector('.day-type-select').value,
                    dayTypeText: row.querySelector('.day-type-text').value || '',
                    atestadoHours: row.querySelector('.atestado-hours').value || '',
                    total: row.querySelector('td:nth-child(8)').textContent,
                    balance: row.querySelector('td:nth-child(9)').textContent
                };
            });
            
            try {
                await saveTimesheet(timesheetKey, daysData);
                timesheets[timesheetKey] = daysData;
                showNotification('Registros do mês salvos com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function clearTimesheet() {
            if (!confirm('Tem certeza que deseja limpar todos os registros deste mês?')) return;
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const timesheetKey = `${currentEmployeeId}-${year}-${month}`;
            delete timesheets[timesheetKey];
            await deleteItem(STORES.TIMESHEETS, timesheetKey);
            generateCalendar();
            showNotification('Registros do mês limpos com sucesso!');
        }

        function autoFillTimesheet() {
            if (!currentEmployeeId) { showNotification('Selecione um funcionário primeiro!', 'error'); return; }
            const employee = employees.find(emp => emp.id === currentEmployeeId);
            if (!employee) return;
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const rows = document.querySelectorAll('#timesheetBody tr');
            rows.forEach(row => {
                const dayType = row.querySelector('.day-type-select').value;
                const day = parseInt(row.querySelector('.entrada').getAttribute('data-day'));
                if (dayType === 'normal') {
                    const currentDate = new Date(year, month, day);
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek === 0) return;
                    const dailyWorkload = getDailyWorkloadForDay(employee, dayOfWeek);
                    if (dailyWorkload.dayOff) return;
                    if (employee.defaultDaysOff && employee.defaultDaysOff.includes(dayOfWeek)) return;
                    if (dailyWorkload.start && dailyWorkload.end) {
                        row.querySelector('.entrada').value = dailyWorkload.start;
                        row.querySelector('.saida').value = dailyWorkload.end;
                        let expectedWorkloadHours;
                        if (employee.dailyWorkloads && employee.dailyWorkloads[dayOfWeek]) {
                            expectedWorkloadHours = employee.dailyWorkloads[dayOfWeek].hours || employee.dailyWorkload || 8;
                        } else {
                            expectedWorkloadHours = employee.dailyWorkload || 8;
                        }
                        if (expectedWorkloadHours > 6) {
                            if (dailyWorkload.lunchStart && dailyWorkload.lunchEnd) {
                                row.querySelector('.saida-intervalo').value = dailyWorkload.lunchStart;
                                row.querySelector('.volta-intervalo').value = dailyWorkload.lunchEnd;
                            } else {
                                const startTime = timeToMinutes(dailyWorkload.start);
                                const endTime = timeToMinutes(dailyWorkload.end);
                                const totalMinutes = endTime - startTime;
                                if (totalMinutes >= 6 * 60) {
                                    const lunchStart = startTime + 4 * 60;
                                    const lunchEnd = lunchStart + 60;
                                    row.querySelector('.saida-intervalo').value = minutesToTime(lunchStart);
                                    row.querySelector('.volta-intervalo').value = minutesToTime(lunchEnd);
                                }
                            }
                        } else {
                            row.querySelector('.saida-intervalo').value = '';
                            row.querySelector('.volta-intervalo').value = '';
                        }
                        calculateDailyTotalForRow(row, dayOfWeek);
                    }
                }
            });
            calculateMonthTotal();
            triggerAutoSave();
            showNotification('Horários preenchidos automaticamente considerando jornada personalizada!');
        }

        function autoUpdateBalances() {
            if (!currentEmployeeId) { showNotification('Selecione um funcionário primeiro!', 'error'); return; }
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const employee = employees.find(emp => emp.id === currentEmployeeId);
            if (!employee) { showNotification('Funcionário não encontrado!', 'error'); return; }
            const rows = document.querySelectorAll('#timesheetBody tr');
            let updatedCount = 0;
            rows.forEach(row => {
                const dayType = row.querySelector('.day-type-select').value;
                const day = parseInt(row.querySelector('.entrada').getAttribute('data-day'));
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();
                if (dayType === 'normal' || dayType === 'atestado') {
                    const entrada = row.querySelector('.entrada').value;
                    const saida = row.querySelector('.saida').value;
                    if (!entrada && !saida) {
                        const expectedWorkload = getDailyWorkloadForDay(employee, dayOfWeek);
                        const expectedMinutes = (expectedWorkload.hours || employee.dailyWorkload || 8) * 60;
                        const atestadoHours = parseFloat(row.querySelector('.atestado-hours')?.value) || 0;
                        const requiredMinutes = dayType === 'atestado' ? expectedMinutes - (atestadoHours * 60) : expectedMinutes;
                        row.querySelector('td:nth-child(8)').textContent = '00:00';
                        const saldoCell = row.querySelector('td:nth-child(9)');
                        saldoCell.textContent = formatMinutes(-requiredMinutes);
                        saldoCell.className = requiredMinutes > 0 ? 'negative-balance' : 'positive-balance';
                        updatedCount++;
                    }
                }
            });
            calculateMonthTotal();
            if (updatedCount > 0) {
                showNotification(`Saldos atualizados automaticamente para ${updatedCount} dias sem registro!`);
                saveTimesheet();
            } else {
                showNotification('Nenhum dia sem registro encontrado para atualização.', 'info');
            }
        }

        function getDailyWorkloadForDay(employee, dayOfWeek) {
            if (employee.dailyWorkloads && employee.dailyWorkloads[dayOfWeek]) {
                return employee.dailyWorkloads[dayOfWeek];
            }
            return {
                start: employee.workdayStart || '08:00',
                end: employee.workdayEnd || '17:00',
                lunchStart: '12:00',
                lunchEnd: '13:00',
                hours: employee.dailyWorkload || 8,
                dayOff: false
            };
        }

        // --- Funções de CRUD de funcionários e feriados (originais) ---
        function updateEmployeeSelects() {
            const employeeSelect = document.getElementById('employeeSelect');
            const exportEmployeeSelect = document.getElementById('exportEmployee');
            const importEmployeeSelect = document.getElementById('importEmployee');
            while (employeeSelect.options.length > 1) employeeSelect.remove(1);
            while (exportEmployeeSelect.options.length > 1) exportEmployeeSelect.remove(1);
            while (importEmployeeSelect.options.length > 1) importEmployeeSelect.remove(1);
            employees.forEach(employee => {
                if (employee.status === 'ativo') {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.id})`;
                    employeeSelect.appendChild(option);
                    exportEmployeeSelect.appendChild(option.cloneNode(true));
                    importEmployeeSelect.appendChild(option.cloneNode(true));
                }
            });
            const firstActiveEmployee = employees.find(emp => emp.status === 'ativo');
            if (firstActiveEmployee && !currentEmployeeId) {
                currentEmployeeId = firstActiveEmployee.id;
                employeeSelect.value = currentEmployeeId;
            }
        }

        function renderEmployeesList() {
            const employeesList = document.getElementById('employeesList');
            if (employees.length === 0) {
                employeesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <p>Nenhum funcionário cadastrado ainda. Use o formulário acima para adicionar.</p>
                    </div>
                `;
                return;
            }
            employeesList.innerHTML = '';
            employees.forEach(employee => {
                const employeeCard = document.createElement('div');
                employeeCard.className = 'employee-card';
                const statusColors = { 'ativo': '#2e7d32', 'inativo': '#d32f2f', 'ferias': '#ff9800', 'afastado': '#9c27b0' };
                employeeCard.style.borderLeftColor = statusColors[employee.status] || '#283593';
                let daysOffText = 'Não definido';
                if (employee.defaultDaysOff && employee.defaultDaysOff.length > 0) {
                    const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
                    daysOffText = employee.defaultDaysOff.map(d => dayNames[d]).join(', ');
                }
                let dailyWorkloadText = '';
                if (employee.dailyWorkloads && Object.keys(employee.dailyWorkloads).length > 0) {
                    dailyWorkloadText = '<div><strong>Jornada personalizada:</strong> Configurada por dia</div>';
                }
                employeeCard.innerHTML = `
                    <div class="employee-name">${employee.name}</div>
                    <div class="employee-details">
                        <div><strong>Matrícula:</strong> ${employee.id}</div>
                        <div><strong>Cargo:</strong> ${employee.department || 'Não informado'}</div>
                        <div><strong>Admissão:</strong> ${employee.admission ? formatDate(employee.admission) : 'Não informada'}</div>
                        <div><strong>Horário padrão:</strong> ${employee.workdayStart || '08:00'} - ${employee.workdayEnd || '17:00'}</div>
                        <div><strong>Jornada:</strong> ${employee.dailyWorkload || 8}h/dia, ${employee.weeklyWorkload || 44}h/semana</div>
                        ${dailyWorkloadText}
                        <div><strong>Folgas padrão:</strong> ${daysOffText}</div>
                        <div><strong>Status:</strong> <span style="color: ${statusColors[employee.status] || '#333'}">${getStatusText(employee.status)}</span></div>
                    </div>
                    <div class="employee-actions">
                        <button class="btn btn-sm btn-secondary edit-employee" data-id="${employee.id}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-sm ${employee.status === 'ativo' ? 'btn-danger' : 'btn-success'} toggle-status" data-id="${employee.id}">
                            <i class="fas fa-user${employee.status === 'ativo' ? '-slash' : '-check'}"></i> ${employee.status === 'ativo' ? 'Desativar' : 'Ativar'}
                        </button>
                    </div>
                `;
                employeesList.appendChild(employeeCard);
            });
            document.querySelectorAll('.edit-employee').forEach(button => {
                button.addEventListener('click', function() {
                    editEmployee(this.getAttribute('data-id'));
                });
            });
            document.querySelectorAll('.toggle-status').forEach(button => {
                button.addEventListener('click', function() {
                    toggleEmployeeStatus(this.getAttribute('data-id'));
                });
            });
        }

        function getStatusText(status) {
            const statusMap = { 'ativo': 'Ativo', 'inativo': 'Inativo', 'ferias': 'Férias', 'afastado': 'Afastado' };
            return statusMap[status] || status;
        }

        async function handleEmployeeForm(e) {
            e.preventDefault();
            const editId = document.getElementById('employeeEditId').value;
            const isEdit = editId !== '';
            const name = document.getElementById('employeeName').value;
            const id = isEdit ? editId : document.getElementById('employeeId').value;
            const department = document.getElementById('employeeDepartment').value;
            const email = document.getElementById('employeeEmail').value;
            const admission = document.getElementById('employeeAdmission').value;
            const status = document.getElementById('employeeStatus').value;
            const workdayStart = document.getElementById('workdayStart').value;
            const workdayEnd = document.getElementById('workdayEnd').value;
            const dailyWorkload = parseFloat(document.getElementById('dailyWorkload').value) || 8;
            const weeklyWorkload = parseFloat(document.getElementById('weeklyWorkload').value) || 44;
            const monthlyWorkload = parseFloat(document.getElementById('monthlyWorkload').value) || 220;
            const daysOffSelect = document.getElementById('employeeFolgas');
            const defaultDaysOff = Array.from(daysOffSelect.selectedOptions).map(option => parseInt(option.value));
            const dailyWorkloads = {};
            for (let i = 0; i < 7; i++) {
                const start = document.getElementById(`dailyStart_${i}`).value;
                const lunchStart = document.getElementById(`dailyLunchStart_${i}`).value;
                const lunchEnd = document.getElementById(`dailyLunchEnd_${i}`).value;
                const end = document.getElementById(`dailyEnd_${i}`).value;
                const hours = document.getElementById(`dailyHours_${i}`).value ? parseFloat(document.getElementById(`dailyHours_${i}`).value) : 0;
                const dayOff = document.getElementById(`dailyDayOff_${i}`).checked;
                if (start || end || lunchStart || lunchEnd || hours > 0) {
                    dailyWorkloads[i] = { start, lunchStart, lunchEnd, end, hours, dayOff };
                }
            }
            if (isEdit) {
                const employeeIndex = employees.findIndex(emp => emp.id === editId);
                if (employeeIndex !== -1) {
                    const updatedEmployee = {
                        ...employees[employeeIndex],
                        name, department, email, admission, status, workdayStart, workdayEnd,
                        dailyWorkload, weeklyWorkload, monthlyWorkload, defaultDaysOff,
                        dailyWorkloads: Object.keys(dailyWorkloads).length > 0 ? dailyWorkloads : null
                    };
                    employees[employeeIndex] = updatedEmployee;
                    await put(STORES.EMPLOYEES, updatedEmployee);
                    updateEmployeeSelects();
                    renderEmployeesList();
                    document.getElementById('employeeModal').style.display = 'none';
                    showNotification('Funcionário atualizado com sucesso!');
                }
            } else {
                if (employees.some(emp => emp.id === id)) {
                    showNotification('Matrícula já cadastrada! Use uma matrícula diferente.', 'error');
                    return;
                }
                const employee = {
                    name, id, department, email, admission, status, workdayStart, workdayEnd,
                    dailyWorkload, weeklyWorkload, monthlyWorkload, defaultDaysOff,
                    dailyWorkloads: Object.keys(dailyWorkloads).length > 0 ? dailyWorkloads : null
                };
                employees.push(employee);
                await put(STORES.EMPLOYEES, employee);
                updateEmployeeSelects();
                renderEmployeesList();
                document.getElementById('employeeModal').style.display = 'none';
                showNotification('Funcionário cadastrado com sucesso!');
            }
        }

        function editEmployee(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            const employeeModal = document.getElementById('employeeModal');
            employeeModal.style.display = 'block';
            isEditingEmployee = true;
            document.getElementById('employeeEditId').value = employee.id;
            document.getElementById('employeeName').value = employee.name;
            document.getElementById('employeeId').value = employee.id;
            document.getElementById('employeeId').disabled = true;
            document.getElementById('employeeDepartment').value = employee.department || '';
            document.getElementById('employeeEmail').value = employee.email || '';
            document.getElementById('employeeAdmission').value = employee.admission || '';
            document.getElementById('employeeStatus').value = employee.status || 'ativo';
            document.getElementById('workdayStart').value = employee.workdayStart || '08:00';
            document.getElementById('workdayEnd').value = employee.workdayEnd || '17:00';
            document.getElementById('dailyWorkload').value = employee.dailyWorkload || 8;
            document.getElementById('weeklyWorkload').value = employee.weeklyWorkload || 44;
            document.getElementById('monthlyWorkload').value = employee.monthlyWorkload || 220;
            const daysOffSelect = document.getElementById('employeeFolgas');
            Array.from(daysOffSelect.options).forEach(option => {
                option.selected = employee.defaultDaysOff && employee.defaultDaysOff.includes(parseInt(option.value));
            });
            if (employee.dailyWorkloads) {
                for (let i = 0; i < 7; i++) {
                    if (employee.dailyWorkloads[i]) {
                        const config = employee.dailyWorkloads[i];
                        document.getElementById(`dailyStart_${i}`).value = config.start || '';
                        document.getElementById(`dailyLunchStart_${i}`).value = config.lunchStart || '';
                        document.getElementById(`dailyLunchEnd_${i}`).value = config.lunchEnd || '';
                        document.getElementById(`dailyEnd_${i}`).value = config.end || '';
                        document.getElementById(`dailyHours_${i}`).value = config.hours || '';
                        document.getElementById(`dailyDayOff_${i}`).checked = config.dayOff || false;
                        const checkbox = document.getElementById(`dailyDayOff_${i}`);
                        const row = checkbox.closest('.daily-workload-row');
                        const inputs = row.querySelectorAll('input:not(.day-off-checkbox)');
                        inputs.forEach(input => { input.disabled = config.dayOff || false; });
                    }
                }
            } else {
                document.getElementById('resetDailyConfig').click();
            }
            const submitBtn = document.getElementById('employeeSubmitBtn');
            submitBtn.innerHTML = '<i class="fas fa-user-edit"></i> Atualizar Funcionário';
            submitBtn.className = 'btn btn-warning';
            showNotification('Funcionário carregado para edição. Atualize os dados e clique em Atualizar.', 'info');
        }

        async function toggleEmployeeStatus(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            employee.status = employee.status === 'ativo' ? 'inativo' : 'ativo';
            await put(STORES.EMPLOYEES, employee);
            updateEmployeeSelects();
            renderEmployeesList();
            showNotification(`Funcionário ${employee.status === 'ativo' ? 'ativado' : 'desativado'} com sucesso!`);
        }

        async function addHoliday(e) {
            e.preventDefault();
            const name = document.getElementById('holidayName').value;
            const type = document.getElementById('holidayType').value;
            const date = document.getElementById('holidayDate').value;
            const recurring = document.getElementById('holidayRecurring').value === 'true';
            const description = document.getElementById('holidayDescription').value;
            const existingHoliday = holidays.find(h => h.date === date && h.name === name);
            if (existingHoliday) {
                showNotification('Já existe um feriado/folga cadastrado com este nome e data!', 'warning');
                return;
            }
            const holiday = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                name, type, date, recurring, description
            };
            holidays.push(holiday);
            await put(STORES.HOLIDAYS, holiday);
            renderHolidaysList();
            document.getElementById('holidayModal').style.display = 'none';
            showNotification(`${type === 'feriado' ? 'Feriado' : 'Folga'} cadastrado com sucesso!`);
            if (currentEmployeeId) {
                const selectedDate = new Date(date);
                if (selectedDate.getFullYear() === currentYear && selectedDate.getMonth() === currentMonth) {
                    generateCalendar();
                }
            }
        }

        async function applyMassLeave() {
            const startDate = document.getElementById('massStartDate').value;
            const endDate = document.getElementById('massEndDate').value;
            const type = document.getElementById('massType').value;
            const reason = document.getElementById('massReason').value;
            if (!startDate || !endDate || !reason) {
                showNotification('Preencha todas as informações para aplicar folgas em massa!', 'error');
                return;
            }
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (start > end) {
                showNotification('A data inicial não pode ser maior que a data final!', 'error');
                return;
            }
            const days = [];
            const currentDate = new Date(start);
            while (currentDate <= end) {
                days.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            if (days.length === 0) {
                showNotification('Nenhum dia selecionado!', 'warning');
                return;
            }
            if (!confirm(`Deseja aplicar ${type} para todos os funcionários do dia ${formatDate(startDate)} ao dia ${formatDate(endDate)}? (${days.length} dias)`)) {
                return;
            }
            for (const day of days) {
                const dateStr = day.toISOString().split('T')[0];
                const holidayName = `${reason} (${formatDate(dateStr)})`;
                const existingHoliday = holidays.find(h => h.date === dateStr && h.name === holidayName);
                if (!existingHoliday) {
                    const holiday = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        name: holidayName,
                        type: type,
                        date: dateStr,
                        recurring: false,
                        description: `Aplicado em massa: ${reason}`
                    };
                    holidays.push(holiday);
                    await put(STORES.HOLIDAYS, holiday);
                }
            }
            renderHolidaysList();
            document.getElementById('massStartDate').value = '';
            document.getElementById('massEndDate').value = '';
            document.getElementById('massReason').value = '';
            showNotification(`${days.length} dias de ${type} aplicados em massa com sucesso!`);
            if (currentEmployeeId) generateCalendar();
        }

        // --- Função renderHolidaysList corrigida (sem problemas de fuso) ---
        async function renderHolidaysList() {
            const holidaysList = document.getElementById('holidaysList');
            const filterYear = document.getElementById('filterYear').value;
            let filteredHolidays = holidays;
            if (filterYear !== 'all') {
                filteredHolidays = holidays.filter(h => {
                    const year = new Date(h.date).getFullYear();
                    return year == filterYear || h.recurring;
                });
            }
            if (filteredHolidays.length === 0) {
                holidaysList.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-calendar-times"></i>
                        <p>Nenhum feriado encontrado para o ano selecionado.</p>
                    </div>
                `;
                return;
            }
            // Ordenação por data (usando comparação de string YYYY-MM-DD)
            filteredHolidays.sort((a, b) => a.date.localeCompare(b.date));
            holidaysList.innerHTML = '';
            filteredHolidays.forEach(holiday => {
                const holidayDate = parseISOLocal(holiday.date);
                const dayOfWeek = holidayDate ? getDayName(holidayDate.getDay()) : '';
                // Formata a data manualmente para evitar deslocamento de fuso
                const [year, month, day] = holiday.date.split('-');
                const dateFormatted = `${day}/${month}/${year}`;
                const typeColors = { 'feriado': '#ff9800', 'folga': '#4caf50', 'recesso': '#2196f3' };
                const typeTexts = { 'feriado': 'Feriado', 'folga': 'Folga', 'recesso': 'Recesso' };
                const holidayItem = document.createElement('div');
                holidayItem.className = 'employee-card';
                holidayItem.style.borderLeftColor = typeColors[holiday.type] || '#283593';
                holidayItem.style.marginBottom = '10px';
                holidayItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${holiday.name}</div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                <i class="far fa-calendar"></i> ${dateFormatted} (${dayOfWeek}) 
                                <span style="margin-left: 10px; color: ${typeColors[holiday.type]}; font-weight: bold;">
                                    ${typeTexts[holiday.type]}
                                </span>
                                ${holiday.recurring ? '<span style="margin-left: 10px; color: #9c27b0;">(Recorrente)</span>' : ''}
                            </div>
                            ${holiday.description ? `<div style="color: #777; font-size: 13px;">${holiday.description}</div>` : ''}
                        </div>
                        <button class="btn btn-sm btn-danger delete-holiday" data-id="${holiday.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                holidaysList.appendChild(holidayItem);
            });
            document.querySelectorAll('.delete-holiday').forEach(button => {
                button.addEventListener('click', async function() {
                    await deleteHoliday(this.getAttribute('data-id'));
                });
            });
        }

        async function deleteHoliday(holidayId) {
            if (!confirm('Tem certeza que deseja excluir este feriado/folga?')) return;
            holidays = holidays.filter(h => h.id !== holidayId);
            await deleteItem(STORES.HOLIDAYS, holidayId);
            renderHolidaysList();
            showNotification('Feriado/folga excluído com sucesso!');
            if (currentEmployeeId) generateCalendar();
        }

        // --- Funções de exportação/importação (originais, com tratamento de erros) ---
        function exportCurrentTimesheet() {
            try {
                if (!currentEmployeeId) { showNotification('Selecione um funcionário primeiro!', 'error'); return; }
                const month = parseInt(document.getElementById('monthSelect').value);
                const year = parseInt(document.getElementById('yearSelect').value);
                const timesheetKey = `${currentEmployeeId}-${year}-${month}`;
                const savedData = timesheets[timesheetKey];
                if (!savedData) { showNotification('Não há dados salvos para este mês!', 'warning'); return; }
                const employee = employees.find(emp => emp.id === currentEmployeeId);
                const monthName = getMonthName(month);
                const totalMonthHours = document.getElementById('totalMonthHours').textContent;
                const totalMonthBalance = document.getElementById('totalMonthBalance').textContent;
                const totalFolgas = document.getElementById('totalFolgas').textContent;
                const totalFeriados = document.getElementById('totalFeriados').textContent;
                const totalAtestados = document.getElementById('totalAtestados').textContent;
                const totalFaltas = document.getElementById('totalFaltas').textContent;
                const data = [];
                data.push([`Registro de Ponto - ${employee.name}`, ...Array(9).fill('')]);
                data.push([`Mês/Ano: ${monthName}/${year}`, ...Array(9).fill('')]);
                data.push([]);
                data.push(["Dia", "Entrada", "Saída (Intervalo)", "Volta (Intervalo)", "Saída", "Total", "Saldo", "Tipo", "Motivo", "Horas Atestado"]);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayData = savedData[day] || { entrada: '', saidaIntervalo: '', voltaIntervalo: '', saida: '', dayType: 'normal', dayTypeText: '', atestadoHours: '', total: '', balance: '' };
                    const formatTime = (time) => !time ? '' : time.length === 5 ? time + ':00' : time;
                    data.push([day, formatTime(dayData.entrada), formatTime(dayData.saidaIntervalo), formatTime(dayData.voltaIntervalo), formatTime(dayData.saida), dayData.total || '', dayData.balance || '', dayData.dayType, dayData.dayTypeText || '', dayData.atestadoHours || '']);
                }
                data.push([]);
                data.push(["Total Horas Normais:", "", "", "", "", totalMonthHours, "", "", "", ""]);
                data.push(["Saldo do Mês:", "", "", "", "", totalMonthBalance, "", "", "", ""]);
                data.push(["Folgas:", totalFolgas, "Feriados:", totalFeriados, "Atestados:", totalAtestados, "Faltas:", totalFaltas, "", ""]);
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wscols = [{wch:6},{wch:10},{wch:15},{wch:15},{wch:10},{wch:10},{wch:10},{wch:12},{wch:20},{wch:12}];
                ws['!cols'] = wscols;
                if (!ws['!merges']) ws['!merges'] = [];
                ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 9 } });
                ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 9 } });
                XLSX.utils.book_append_sheet(wb, ws, "Ponto Mensal");
                const fileName = `Ponto_${employee.name.replace(/\s+/g, '_')}_${monthName}_${year}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showNotification('Arquivo Excel exportado com layout moderno!');
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                showNotification('Erro ao exportar Excel: ' + error.message, 'error');
            }
        }

        function exportCurrentTimesheetPDF() {
            try {
                if (!currentEmployeeId) { showNotification('Selecione um funcionário primeiro!', 'error'); return; }
                const month = parseInt(document.getElementById('monthSelect').value);
                const year = parseInt(document.getElementById('yearSelect').value);
                const timesheetKey = `${currentEmployeeId}-${year}-${month}`;
                const savedData = timesheets[timesheetKey];
                if (!savedData) { showNotification('Não há dados salvos para este mês!', 'warning'); return; }
                const employee = employees.find(emp => emp.id === currentEmployeeId);
                const monthName = getMonthName(month);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                const marginLeft = 15, marginRight = 15, marginTop = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                doc.setFontSize(20); doc.setTextColor(40,53,147); doc.text('ESPELHO DE PONTO MENSAL', pageWidth/2, marginTop, { align: 'center' });
                doc.setFontSize(12); doc.setTextColor(0,0,0); let yPos = marginTop+10;
                doc.text(`Funcionário: ${employee.name}`, marginLeft, yPos);
                doc.text(`Mês/Ano: ${monthName}/${year}`, pageWidth-marginRight, yPos, { align: 'right' });
                yPos += 8; doc.text(`Matrícula: ${employee.id}`, marginLeft, yPos);
                let workloadText = `Jornada: ${employee.dailyWorkload || 8}h/dia`;
                if (employee.dailyWorkloads) workloadText += ' (Personalizada por dia)';
                doc.text(workloadText, pageWidth-marginRight, yPos, { align: 'right' });
                yPos += 8; doc.text(`Departamento: ${employee.department || 'Não informado'}`, marginLeft, yPos);
                doc.text(`Emissão: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth-marginRight, yPos, { align: 'right' });
                yPos += 10; doc.setDrawColor(200,200,200); doc.line(marginLeft, yPos, pageWidth-marginRight, yPos); yPos += 5;
                const headers = [["Dia", "Dia Semana", "Tipo", "Entrada", "Saída Int.", "Volta Int.", "Saída", "Total", "Saldo", "Atestado (h)"]];
                const daysInMonth = new Date(year, month+1, 0).getDate();
                const tableData = [];
                let totalHorasNormais = 0, totalSaldo = 0, totalFolgas = 0, totalFeriados = 0, totalAtestados = 0, totalFaltas = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    const dayName = getDayName(currentDate.getDay());
                    const dayData = savedData[day] || { entrada: '', saidaIntervalo: '', voltaIntervalo: '', saida: '', dayType: 'normal', dayTypeText: '', atestadoHours: '', total: '', balance: '' };
                    let tipoDia = 'Normal';
                    if (dayData.dayType === 'folga') { tipoDia = 'Folga'; totalFolgas++; }
                    else if (dayData.dayType === 'feriado') { tipoDia = 'Feriado'; totalFeriados++; }
                    else if (dayData.dayType === 'atestado') { tipoDia = 'Atestado'; totalAtestados++; }
                    else if (dayData.dayType === 'falta') { tipoDia = 'Falta'; totalFaltas++; }
                    if (dayData.dayType === 'normal' || dayData.dayType === 'atestado') {
                        if (dayData.total) {
                            const [hours, minutes] = dayData.total.replace(/[+-]/, '').split(':').map(Number);
                            totalHorasNormais += hours*60 + minutes;
                        }
                        if (dayData.balance && dayData.balance.trim() !== '') {
                            const isNegative = dayData.balance.startsWith('-');
                            const [bHours, bMinutes] = dayData.balance.replace(/[+-]/, '').split(':').map(Number);
                            totalSaldo += (isNegative ? -1 : 1) * (bHours*60 + bMinutes);
                        }
                    }
                    tableData.push([day.toString(), dayName, tipoDia, dayData.entrada||'', dayData.saidaIntervalo||'', dayData.voltaIntervalo||'', dayData.saida||'', dayData.total||'', dayData.balance||'', dayData.atestadoHours||'']);
                }
                doc.autoTable({ startY: yPos, head: headers, body: tableData, margin: { left: marginLeft, right: marginRight }, styles: { fontSize:8, cellPadding:2 }, headStyles: { fillColor:[40,53,147], textColor:[255,255,255] }, alternateRowStyles: { fillColor:[245,245,245] }, theme:'grid' });
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12); doc.setTextColor(40,53,147); doc.text('RESUMO DO MÊS', marginLeft, finalY);
                doc.setFontSize(10); doc.setTextColor(0,0,0);
                const formatMinutesToHours = (minutes) => { const sign = minutes<0?'-':'+'; const abs = Math.abs(minutes); const h = Math.floor(abs/60); const m = abs%60; return `${sign}${h}h ${m}m`; };
                let resumoY = finalY + 8;
                doc.text(`Horas Trabalhadas: ${formatMinutesToHours(totalHorasNormais)}`, marginLeft, resumoY);
                doc.text(`Saldo Total: ${formatMinutesToHours(totalSaldo)}`, marginLeft+60, resumoY);
                resumoY += 6; doc.text(`Folgas: ${totalFolgas} dias`, marginLeft, resumoY); doc.text(`Feriados: ${totalFeriados} dias`, marginLeft+60, resumoY);
                resumoY += 6; doc.text(`Atestados: ${totalAtestados} dias`, marginLeft, resumoY); doc.text(`Faltas: ${totalFaltas} dias`, marginLeft+60, resumoY);
                const footerY = doc.internal.pageSize.getHeight() - 20;
                doc.setFontSize(8); doc.setTextColor(128,128,128); doc.text('Sistema de Ponto Completo - Documento gerado automaticamente', pageWidth/2, footerY, { align:'center' });
                const assinaturaY = footerY - 20;
                doc.setFontSize(10); doc.setTextColor(0,0,0); doc.line(marginLeft, assinaturaY, marginLeft+60, assinaturaY); doc.line(pageWidth-marginRight-60, assinaturaY, pageWidth-marginRight, assinaturaY);
                doc.text('Assinatura do Funcionário', marginLeft+30, assinaturaY+5, { align:'center' }); doc.text('Assinatura do Responsável', pageWidth-marginRight-30, assinaturaY+5, { align:'center' });
                const fileName = `Espelho_Ponto_${employee.name.replace(/\s+/g, '_')}_${monthName}_${year}.pdf`;
                doc.save(fileName);
                showNotification('PDF gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                showNotification('Erro ao exportar PDF: ' + error.message, 'error');
            }
        }

        function exportConsolidatedReportPDF() {
            try {
                const employeeId = document.getElementById('exportEmployee').value;
                const month = document.getElementById('exportMonth').value;
                const year = document.getElementById('exportYear').value;
                if (employeeId === 'all') { showNotification('Selecione um funcionário específico para o relatório consolidado!', 'error'); return; }
                const employee = employees.find(emp => emp.id === employeeId);
                if (!employee) { showNotification('Funcionário não encontrado!', 'error'); return; }
                const employeeSheets = Object.keys(timesheets).filter(key => key.startsWith(employee.id));
                if (employeeSheets.length === 0) { showNotification('Nenhum registro encontrado para este funcionário!', 'warning'); return; }
                employeeSheets.sort((a,b) => { const [idA,yA,mA]=a.split('-'); const [idB,yB,mB]=b.split('-'); if(yA!==yB) return yA-yB; return mA-mB; });
                let filteredSheets = employeeSheets;
                if (month !== 'all' || year !== 'all') {
                    filteredSheets = employeeSheets.filter(key => { const [id,sY,sM]=key.split('-'); return (month==='all' || sM===month) && (year==='all' || sY===year); });
                }
                if (filteredSheets.length === 0) { showNotification('Nenhum registro encontrado para os filtros selecionados!', 'warning'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const marginLeft = 15, marginRight = 15, marginTop = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                doc.setFontSize(20); doc.setTextColor(40,53,147); doc.text('RELATÓRIO CONSOLIDADO DE PONTO', pageWidth/2, marginTop, { align:'center' });
                doc.setFontSize(12); doc.setTextColor(0,0,0); let yPos = marginTop+10;
                doc.text(`Funcionário: ${employee.name}`, marginLeft, yPos);
                doc.text(`Matrícula: ${employee.id}`, pageWidth-marginRight, yPos, { align:'right' });
                yPos += 8; doc.text(`Departamento: ${employee.department || 'Não informado'}`, marginLeft, yPos);
                doc.text(`Período: ${month!=='all'?getMonthName(parseInt(month))+'/':''}${year!=='all'?year:'Todos'}`, pageWidth-marginRight, yPos, { align:'right' });
                yPos += 8; doc.text(`Jornada: ${employee.dailyWorkload||8}h/dia, ${employee.weeklyWorkload||44}h/semana`, marginLeft, yPos);
                doc.text(`Emissão: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth-marginRight, yPos, { align:'right' });
                yPos += 5;
                const headers = [["Mês/Ano", "Dias Úteis", "Horas Trabalhadas", "Saldo Total", "Folgas", "Feriados", "Atestados", "Faltas"]];
                const tableData = [];
                let totalGeralHorasTrabalhadas = 0, totalGeralSaldo = 0, totalGeralDiasUteis = 0, totalGeralFolgas = 0, totalGeralFeriados = 0, totalGeralAtestados = 0, totalGeralFaltas = 0;
                filteredSheets.forEach(key => {
                    const [empId, sheetYear, sheetMonth] = key.split('-');
                    const monthName = getMonthName(parseInt(sheetMonth));
                    const daysData = timesheets[key];
                    let horasTrabalhadasMes = 0, saldoMes = 0, diasUteisMes = 0, folgasMes = 0, feriadosMes = 0, atestadosMes = 0, faltasMes = 0;
                    const daysInMonth = new Date(sheetYear, parseInt(sheetMonth)+1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayData = daysData && daysData[day] ? daysData[day] : { dayType:'normal', total:'', balance:'' };
                        if (dayData.dayType === 'normal' || dayData.dayType === 'atestado') {
                            diasUteisMes++;
                            if (dayData.total && dayData.total.trim()!=='') {
                                const [hours, minutes] = dayData.total.replace(/[+-]/, '').split(':').map(Number);
                                horasTrabalhadasMes += hours*60 + minutes;
                            }
                            if (dayData.balance && dayData.balance.trim()!=='') {
                                const isNegative = dayData.balance.startsWith('-');
                                const [bHours, bMinutes] = dayData.balance.replace(/[+-]/, '').split(':').map(Number);
                                saldoMes += (isNegative ? -1 : 1) * (bHours*60 + bMinutes);
                            }
                        } else if (dayData.dayType === 'folga') folgasMes++;
                        else if (dayData.dayType === 'feriado') feriadosMes++;
                        else if (dayData.dayType === 'atestado') atestadosMes++;
                        else if (dayData.dayType === 'falta') faltasMes++;
                    }
                    tableData.push([`${monthName}/${sheetYear}`, diasUteisMes.toString(), formatMinutesToHM(horasTrabalhadasMes), formatMinutesToHM(saldoMes, true), folgasMes.toString(), feriadosMes.toString(), atestadosMes.toString(), faltasMes.toString()]);
                    totalGeralHorasTrabalhadas += horasTrabalhadasMes;
                    totalGeralSaldo += saldoMes;
                    totalGeralDiasUteis += diasUteisMes;
                    totalGeralFolgas += folgasMes;
                    totalGeralFeriados += feriadosMes;
                    totalGeralAtestados += atestadosMes;
                    totalGeralFaltas += faltasMes;
                });
                tableData.push(["TOTAL GERAL", totalGeralDiasUteis.toString(), formatMinutesToHM(totalGeralHorasTrabalhadas), formatMinutesToHM(totalGeralSaldo, true), totalGeralFolgas.toString(), totalGeralFeriados.toString(), totalGeralAtestados.toString(), totalGeralFaltas.toString()]);
                doc.autoTable({ startY: yPos, head: headers, body: tableData, margin: { left: marginLeft, right: marginRight }, styles: { fontSize:9 }, headStyles: { fillColor:[40,53,147], textColor:[255,255,255] }, alternateRowStyles: { fillColor:[245,245,245] }, theme:'grid' });
                const fileName = `Relatorio_Consolidado_${employee.name.replace(/\s+/g, '_')}_${month!=='all'?getMonthName(parseInt(month)):''}${year!=='all'?year:''}.pdf`;
                doc.save(fileName);
                showNotification('Relatório consolidado gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar relatório consolidado PDF:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        function exportAllMonthsPDF() {
            try {
                const employeeId = document.getElementById('exportEmployee').value;
                if (employeeId === 'all') { showNotification('Selecione um funcionário específico!', 'error'); return; }
                const employee = employees.find(emp => emp.id === employeeId);
                if (!employee) { showNotification('Funcionário não encontrado!', 'error'); return; }
                const employeeSheets = Object.keys(timesheets).filter(key => key.startsWith(employee.id));
                if (employeeSheets.length === 0) { showNotification('Nenhum registro encontrado para este funcionário!', 'warning'); return; }
                employeeSheets.sort((a,b) => { const [idA,yA,mA]=a.split('-'); const [idB,yB,mB]=b.split('-'); if(yA!==yB) return yA-yB; return mA-mB; });
                employeeSheets.forEach((key, index) => {
                    const [empId, year, month] = key.split('-');
                    const originalEmployeeId = currentEmployeeId;
                    const originalMonth = currentMonth;
                    const originalYear = currentYear;
                    currentEmployeeId = employeeId;
                    currentMonth = parseInt(month);
                    currentYear = parseInt(year);
                    setTimeout(() => {
                        exportCurrentTimesheetPDF();
                        if (index === employeeSheets.length - 1) {
                            currentEmployeeId = originalEmployeeId;
                            currentMonth = originalMonth;
                            currentYear = originalYear;
                            if (originalEmployeeId) {
                                document.getElementById('monthSelect').value = originalMonth;
                                document.getElementById('yearSelect').value = originalYear;
                                document.getElementById('employeeSelect').value = originalEmployeeId;
                                generateCalendar();
                            }
                        }
                    }, index * 1000);
                });
                showNotification(`Gerando ${employeeSheets.length} PDF(s)... Aguarde os downloads.`);
            } catch (error) {
                console.error('Erro ao exportar todos os meses PDF:', error);
                showNotification('Erro ao exportar: ' + error.message, 'error');
            }
        }

        function exportToExcel() {
            try {
                const employeeId = document.getElementById('exportEmployee').value;
                const month = document.getElementById('exportMonth').value;
                const year = document.getElementById('exportYear').value;
                const wb = XLSX.utils.book_new();
                if (employeeId === 'all') {
                    employees.forEach(employee => {
                        Object.keys(timesheets).forEach(key => {
                            if (key.startsWith(employee.id)) {
                                const [empId, sheetYear, sheetMonth] = key.split('-');
                                if ((month === 'all' || sheetMonth === month) && (year === 'all' || sheetYear === year)) {
                                    const monthName = getMonthName(parseInt(sheetMonth));
                                    const daysData = timesheets[key];
                                    const data = [["Dia", "Entrada", "Saída (Intervalo)", "Volta (Intervalo)", "Saída", "Total", "Saldo", "Tipo", "Motivo", "Horas Atestado"]];
                                    const daysInMonth = new Date(sheetYear, parseInt(sheetMonth)+1, 0).getDate();
                                    for (let day = 1; day <= daysInMonth; day++) {
                                        const dayData = daysData[day] || { entrada:'', saidaIntervalo:'', voltaIntervalo:'', saida:'', dayType:'normal', dayTypeText:'', atestadoHours:'', total:'', balance:'' };
                                        const formatTime = (time) => !time ? '' : time.length === 5 ? time+':00' : time;
                                        data.push([day, formatTime(dayData.entrada), formatTime(dayData.saidaIntervalo), formatTime(dayData.voltaIntervalo), formatTime(dayData.saida), dayData.total||'', dayData.balance||'', dayData.dayType, dayData.dayTypeText||'', dayData.atestadoHours||'']);
                                    }
                                    const ws = XLSX.utils.aoa_to_sheet(data);
                                    const wscols = [{wch:5},{wch:10},{wch:15},{wch:15},{wch:10},{wch:10},{wch:10},{wch:12},{wch:20},{wch:12}];
                                    ws['!cols'] = wscols;
                                    const sheetName = `${employee.name.substring(0,15)}_${monthName}_${sheetYear}`.substring(0,31);
                                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                                }
                            }
                        });
                    });
                } else {
                    Object.keys(timesheets).forEach(key => {
                        if (key.startsWith(employeeId)) {
                            const [empId, sheetYear, sheetMonth] = key.split('-');
                            if ((month === 'all' || sheetMonth === month) && (year === 'all' || sheetYear === year)) {
                                const employee = employees.find(emp => emp.id === empId);
                                const monthName = getMonthName(parseInt(sheetMonth));
                                const daysData = timesheets[key];
                                const data = [["Dia", "Entrada", "Saída (Intervalo)", "Volta (Intervalo)", "Saída", "Total", "Saldo", "Tipo", "Motivo", "Horas Atestado"]];
                                const daysInMonth = new Date(sheetYear, parseInt(sheetMonth)+1, 0).getDate();
                                for (let day = 1; day <= daysInMonth; day++) {
                                    const dayData = daysData[day] || { entrada:'', saidaIntervalo:'', voltaIntervalo:'', saida:'', dayType:'normal', dayTypeText:'', atestadoHours:'', total:'', balance:'' };
                                    const formatTime = (time) => !time ? '' : time.length === 5 ? time+':00' : time;
                                    data.push([day, formatTime(dayData.entrada), formatTime(dayData.saidaIntervalo), formatTime(dayData.voltaIntervalo), formatTime(dayData.saida), dayData.total||'', dayData.balance||'', dayData.dayType, dayData.dayTypeText||'', dayData.atestadoHours||'']);
                                }
                                const ws = XLSX.utils.aoa_to_sheet(data);
                                const wscols = [{wch:5},{wch:10},{wch:15},{wch:15},{wch:10},{wch:10},{wch:10},{wch:12},{wch:20},{wch:12}];
                                ws['!cols'] = wscols;
                                const sheetName = `${monthName}_${sheetYear}`;
                                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                            }
                        }
                    });
                }
                if (wb.SheetNames.length === 0) { showNotification('Nenhum dado encontrado para exportar!', 'warning'); return; }
                const fileName = `Registro_Ponto_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showNotification('Dados exportados com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar para Excel:', error);
                showNotification('Erro ao exportar para Excel: ' + error.message, 'error');
            }
        }

        function importFromExcel() {
            try {
                const employeeId = document.getElementById('importEmployee').value;
                const fileInput = document.getElementById('importFile');
                if (!employeeId) { showNotification('Selecione um funcionário para importação!', 'error'); return; }
                if (!fileInput.files.length) { showNotification('Selecione um arquivo Excel para importar!', 'error'); return; }
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type:'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header:1});
                        if (jsonData.length < 2) throw new Error('Arquivo sem dados');
                        const month = parseInt(prompt("Digite o número do mês (1-12):", new Date().getMonth()+1)) - 1;
                        const year = parseInt(prompt("Digite o ano:", new Date().getFullYear()));
                        if (isNaN(month) || month<0 || month>11 || isNaN(year)) throw new Error('Mês ou ano inválido');
                        const timesheetKey = `${employeeId}-${year}-${month}`;
                        const daysData = {};
                        for (let i=1; i<jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length >= 5) {
                                const day = parseInt(row[0]);
                                const formatTimeFromExcel = (excelTime) => {
                                    if (!excelTime) return '';
                                    if (typeof excelTime === 'number') {
                                        const totalSeconds = Math.floor(excelTime * 24 * 60 * 60);
                                        const hours = Math.floor(totalSeconds / 3600);
                                        const minutes = Math.floor((totalSeconds % 3600) / 60);
                                        return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;
                                    }
                                    const timeStr = String(excelTime);
                                    if (timeStr.includes(':')) {
                                        const parts = timeStr.split(':');
                                        return `${parts[0].padStart(2,'0')}:${parts[1].padStart(2,'0')}`;
                                    }
                                    return '';
                                };
                                const dayData = {
                                    entrada: formatTimeFromExcel(row[1]),
                                    saidaIntervalo: formatTimeFromExcel(row[2]),
                                    voltaIntervalo: formatTimeFromExcel(row[3]),
                                    saida: formatTimeFromExcel(row[4]),
                                    dayType: row[7] ? row[7].toLowerCase() : 'normal',
                                    dayTypeText: row[8] || '',
                                    atestadoHours: row[9] || '',
                                    total: '',
                                    balance: ''
                                };
                                if (dayData.entrada && dayData.saida && (dayData.dayType==='normal'||dayData.dayType==='atestado')) {
                                    const employee = employees.find(emp => emp.id === employeeId);
                                    if (employee) {
                                        const currentDate = new Date(year, month, day);
                                        const dayOfWeek = currentDate.getDay();
                                        const resultado = calculateDailyBalance(dayData, employee, dayOfWeek);
                                        dayData.total = resultado.total;
                                        dayData.balance = resultado.balance;
                                    }
                                }
                                daysData[day] = dayData;
                            }
                        }
                        timesheets[timesheetKey] = daysData;
                        await saveTimesheet(timesheetKey, daysData);
                        showNotification(`Dados importados com sucesso para ${getMonthName(month)}/${year}!`);
                        fileInput.value = '';
                        if (employeeId === currentEmployeeId && month === parseInt(document.getElementById('monthSelect').value) && year === parseInt(document.getElementById('yearSelect').value)) {
                            generateCalendar();
                        }
                    } catch (error) {
                        showNotification('Erro ao importar arquivo: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Erro ao importar:', error);
                showNotification('Erro ao importar: ' + error.message, 'error');
            }
        }

        async function exportBackup() {
            try {
                const backupData = { employees, timesheets, holidays, exportDate: new Date().toISOString(), version: '5.0-indexeddb' };
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `backup_ponto_completo_${new Date().toISOString().split('T')[0]}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showNotification('Backup exportado com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar backup:', error);
                showNotification('Erro ao exportar backup: ' + error.message, 'error');
            }
        }

        async function importBackupMerge() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(event) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            if (!backupData.employees || !backupData.timesheets || !backupData.holidays) throw new Error('Formato de arquivo inválido');
                            let addedEmployees = 0, updatedEmployees = 0, addedTimesheets = 0, updatedTimesheets = 0, addedHolidays = 0;
                            for (const backupEmp of backupData.employees) {
                                const existingIndex = employees.findIndex(emp => emp.id === backupEmp.id);
                                if (existingIndex === -1) {
                                    employees.push(backupEmp);
                                    await put(STORES.EMPLOYEES, backupEmp);
                                    addedEmployees++;
                                } else {
                                    const existingEmp = employees[existingIndex];
                                    const mergedEmp = { ...backupEmp, ...existingEmp };
                                    employees[existingIndex] = mergedEmp;
                                    await put(STORES.EMPLOYEES, mergedEmp);
                                    updatedEmployees++;
                                }
                            }
                            for (const backupHoliday of backupData.holidays) {
                                const existingHoliday = holidays.find(h => h.id === backupHoliday.id || (h.name === backupHoliday.name && h.date === backupHoliday.date));
                                if (!existingHoliday) {
                                    holidays.push(backupHoliday);
                                    await put(STORES.HOLIDAYS, backupHoliday);
                                    addedHolidays++;
                                }
                            }
                            for (const [key, backupDays] of Object.entries(backupData.timesheets)) {
                                if (!timesheets[key]) {
                                    timesheets[key] = backupDays;
                                    await saveTimesheet(key, backupDays);
                                    addedTimesheets++;
                                } else {
                                    const existingDays = timesheets[key];
                                    let daysAdded = 0, daysUpdated = 0;
                                    for (const [day, backupDay] of Object.entries(backupDays)) {
                                        if (!existingDays[day]) {
                                            existingDays[day] = backupDay;
                                            daysAdded++;
                                        } else if (backupDay.entrada && backupDay.saida && (!existingDays[day].entrada || !existingDays[day].saida)) {
                                            existingDays[day] = backupDay;
                                            daysUpdated++;
                                        } else if (backupDay.dayType !== 'normal' && existingDays[day].dayType === 'normal') {
                                            existingDays[day].dayType = backupDay.dayType;
                                            existingDays[day].dayTypeText = backupDay.dayTypeText;
                                            existingDays[day].atestadoHours = backupDay.atestadoHours || '';
                                            daysUpdated++;
                                        }
                                    }
                                    if (daysAdded>0 || daysUpdated>0) {
                                        updatedTimesheets++;
                                        await saveTimesheet(key, existingDays);
                                    }
                                }
                            }
                            if (addedEmployees>0 || updatedEmployees>0 || addedTimesheets>0 || updatedTimesheets>0 || addedHolidays>0) {
                                updateEmployeeSelects();
                                renderEmployeesList();
                                renderHolidaysList();
                                if (currentEmployeeId) generateCalendar();
                                let message = 'Backup mesclado com sucesso! ';
                                if (addedEmployees>0) message += `Adicionados: ${addedEmployees} funcionários. `;
                                if (updatedEmployees>0) message += `Atualizados: ${updatedEmployees} funcionários. `;
                                if (addedTimesheets>0) message += `Adicionados: ${addedTimesheets} registros de ponto. `;
                                if (updatedTimesheets>0) message += `Atualizados: ${updatedTimesheets} registros de ponto. `;
                                if (addedHolidays>0) message += `Adicionados: ${addedHolidays} feriados.`;
                                showNotification(message.trim());
                            } else {
                                showNotification('Nenhum novo dado encontrado no backup. Todos os dados já existem no sistema.', 'warning');
                            }
                        } catch (error) {
                            showNotification('Erro ao restaurar backup: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            } catch (error) {
                console.error('Erro ao importar backup:', error);
                showNotification('Erro ao importar backup: ' + error.message, 'error');
            }
        }

        async function clearAllData() {
            try {
                if (!confirm('Isso apagará TODOS os dados (funcionários, registros e feriados). Tem certeza?')) return;
                await clearStore(STORES.EMPLOYEES);
                await clearStore(STORES.TIMESHEETS);
                await clearStore(STORES.HOLIDAYS);
                employees = [];
                timesheets = {};
                holidays = generateHolidaysFromBase(null);
                for (const h of holidays) {
                    await put(STORES.HOLIDAYS, h);
                }
                currentEmployeeId = '';
                updateEmployeeSelects();
                renderEmployeesList();
                renderHolidaysList();
                document.getElementById('timesheetBody').innerHTML = `<tr><td colspan="10" class="empty-state"><i class="fas fa-calendar-day"></i><p>Selecione um funcionário, mês e ano para começar</p></td></tr>`;
                document.getElementById('totalMonthHours').textContent = '00:00';
                document.getElementById('totalMonthBalance').textContent = '00:00';
                document.getElementById('totalFolgas').textContent = '0';
                document.getElementById('totalFeriados').textContent = '0';
                document.getElementById('totalAtestados').textContent = '0';
                document.getElementById('totalFaltas').textContent = '0';
                document.getElementById('resetDailyConfig').click();
                showNotification('Todos os dados foram removidos! Feriados padrão restaurados.', 'warning');
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                showNotification('Erro ao limpar dados: ' + error.message, 'error');
            }
        }

        // --- Função formatDate corrigida (usa string diretamente) ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const [y, m, d] = dateString.split('-');
            return `${d}/${m}/${y}`;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            const icon = notification.querySelector('i');
            if (type === 'error') icon.className = 'fas fa-exclamation-circle';
            else if (type === 'warning') icon.className = 'fas fa-exclamation-triangle';
            else icon.className = 'fas fa-check-circle';
            notification.classList.add('show');
            setTimeout(() => { notification.classList.remove('show'); }, 3000);
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
